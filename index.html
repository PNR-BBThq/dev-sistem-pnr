<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem PNR Digital</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
  :root { --primary: #064e3b; --bg: #f3f4f6; }
  body { background: var(--bg); font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; }
  .sidebar { width: 260px; height: 100vh; position: fixed; background: #e8f5e9; border-right: 1px solid #c6e7ce; padding: 20px; z-index: 100; }
  .main-content { margin-left: 260px; padding: 25px; }
  .verify-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
  .nav-item { padding: 10px 15px; margin-bottom: 5px; cursor: pointer; font-weight: 600; border-radius: 8px; }
  .nav-item.active { background: #1b5e20; color: white; }
  .nav-item:hover:not(.active) { background: #c8e6c9; }
  #loginOverlay { position: fixed; inset: 0; background: #064e3b; z-index: 9999; display: flex; align-items: center; justify-content: center; }
  .login-box { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; }
  /* STYLE GAMBAR BUTTON */
  .img-btn-row { display: flex; align-items: center; justify-content: space-between; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; background: #fff; margin-bottom: 5px; }
  @media(max-width:768px){ .sidebar{display:none;} .main-content{margin-left:0;} }
</style>
</head>
<body>

<div id="loginOverlay"><div class="login-box">
  <h4 class="mb-4 fw-bold">PNR DIGITAL</h4>
  <input type="text" id="uid" class="form-control mb-3" placeholder="ID">
  <input type="password" id="pwd" class="form-control mb-3" placeholder="Kata Laluan">
  <button onclick="doLogin()" class="btn btn-success w-100 fw-bold">MASUK</button>
  <div id="loginMsg" class="text-danger mt-2 small fw-bold"></div>
</div></div>

<div class="sidebar">
  <div class="h5 fw-bold mb-4"><i class="bi bi-flower1"></i> PNR SYSTEM</div>
  <div class="nav-item active" onclick="nav('main')"><i class="bi bi-grid me-2"></i> Dashboard</div>
  <div class="nav-item" id="navTask" style="display:none" onclick="nav('tasks')"><i class="bi bi-list-task me-2"></i> Tugasan Saya <span class="badge bg-danger ms-2" id="badgeTask">0</span></div>
  <div class="nav-item" id="navVer" style="display:none" onclick="nav('verify')"><i class="bi bi-check-circle me-2"></i> Pengesahan</div>
  <div class="nav-item" onclick="nav('form')"><i class="bi bi-plus-lg me-2"></i> Tambah Data</div>
  <div class="mt-auto pt-4 border-top">
    <small class="d-block text-muted">Pengguna</small>
    <div class="fw-bold" id="uName">-</div>
    <button class="btn btn-sm btn-link text-danger p-0 mt-2" onclick="logout()">Log Keluar</button>
  </div>
</div>

<div class="main-content">
  <div id="view-main">
    <h4 class="fw-bold mb-4">Analisis Data</h4>
    <div class="row g-3 mb-4">
      <div class="col-md-3"><div class="kpi-card bg-white p-3 border rounded"><div>Luas Bancian</div><div class="h3 fw-bold text-success" id="k1">0</div></div></div>
      <div class="col-md-3"><div class="kpi-card bg-white p-3 border rounded"><div>Luas Serangan</div><div class="h3 fw-bold text-danger" id="k2">0</div></div></div>
      <div class="col-md-3"><div class="kpi-card bg-white p-3 border rounded"><div>Peratus</div><div class="h3 fw-bold text-warning" id="k3">0%</div></div></div>
      <div class="col-md-3"><div class="kpi-card bg-white p-3 border rounded"><div>Rekod</div><div class="h3 fw-bold text-primary" id="k4">0</div></div></div>
    </div>
    <div class="bg-white border rounded overflow-hidden">
        <table class="table table-hover mb-0"><thead class="table-light"><tr><th>Tarikh</th><th>Lokasi</th><th>Tanaman</th><th>Luas(S)</th><th>Tindakan</th></tr></thead><tbody id="tbMain"></tbody></table>
    </div>
  </div>

  <div id="view-tasks" style="display:none">
    <div class="d-flex justify-content-between mb-4">
        <h4 class="fw-bold">Tugasan Saya</h4>
        <button class="btn btn-primary btn-sm" onclick="loadTasks()">Refresh</button>
    </div>
    <div class="row" id="taskContainer"></div>
  </div>

  <div id="view-verify" style="display:none">
    <div class="d-flex justify-content-between mb-4">
        <h4 class="fw-bold">Pengesahan Data</h4>
        <button class="btn btn-primary btn-sm" onclick="loadVerify()">Refresh</button>
    </div>
    <div class="row" id="verBox"></div>
  </div>

  <div id="view-form" style="display:none; height:90vh">
      <iframe id="ifr" style="width:100%;height:100%;border:0"></iframe>
  </div>
</div>

<div class="modal fade" id="mdlEdit" data-bs-backdrop="static"><div class="modal-dialog modal-lg"><div class="modal-content">
  <div class="modal-header bg-success text-white">
    <h6 class="modal-title fw-bold">KEMASKINI TUGASAN</h6>
    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body bg-light">
    <input type="hidden" id="e_row">
    
    <h6 class="text-primary border-bottom pb-2">A. Info Lokasi</h6>
    <div class="row g-2 mb-2">
      <div class="col-6"><label class="small fw-bold">Negeri</label><input type="text" id="e_neg" class="form-control form-control-sm"></div>
      <div class="col-6"><label class="small fw-bold">Daerah</label><input type="text" id="e_dae" class="form-control form-control-sm"></div>
    </div>
    <div class="mb-2"><label class="small fw-bold">Lokasi</label><input type="text" id="e_lok" class="form-control form-control-sm"></div>
    <div class="row g-2 mb-2">
      <div class="col-6"><label class="small fw-bold">Tarikh</label><input type="date" id="e_date" class="form-control form-control-sm"></div>
      <div class="col-6"><label class="small fw-bold">Koordinat</label><input type="text" id="e_gps" class="form-control form-control-sm"></div>
    </div>

    <h6 class="text-primary border-bottom pb-2 mt-3">B. Tanaman</h6>
    <div class="row g-2 mb-2">
      <div class="col-6"><label class="small fw-bold">Kategori</label><input type="text" id="e_cat" class="form-control form-control-sm"></div>
      <div class="col-6"><label class="small fw-bold">Tanaman</label><input type="text" id="e_crop" class="form-control form-control-sm"></div>
    </div>
    <div class="row g-2 mb-2">
      <div class="col-6"><label class="small fw-bold">Varieti</label><input type="text" id="e_var" class="form-control form-control-sm"></div>
      <div class="col-6"><label class="small fw-bold">Luas (Ha)</label><input type="number" id="e_ha" class="form-control form-control-sm"></div>
    </div>

    <h6 class="text-primary border-bottom pb-2 mt-3">C. Serangan</h6>
    <table class="table table-sm table-bordered bg-white" id="tbPest">
      <thead class="table-light"><tr><th>Perosak</th><th width="80">Luas(Ha)</th><th width="60">Tahap</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="d-flex gap-2 mb-3">
        <select id="selPest" class="form-select form-select-sm"><option value="">- Pilih Perosak -</option></select>
        <button class="btn btn-outline-primary btn-sm" onclick="addPest()">+ Tambah</button>
    </div>

    <h6 class="text-primary border-bottom pb-2 mt-3">D. Gambar & Keterangan</h6>
    <div class="mb-2"><label class="small fw-bold">Gambar Sedia Ada:</label><div id="listImg"></div></div>
    <div class="mb-2"><label class="small fw-bold">Upload Baru:</label><input type="file" id="e_file" class="form-control form-control-sm" multiple></div>
    <div class="mb-2"><label class="small fw-bold">Keterangan Gambar (Caption):</label><textarea id="e_cap" class="form-control" rows="2"></textarea></div>

    <h6 class="text-primary border-bottom pb-2 mt-3">E. Syor</h6>
    <textarea id="e_syor" class="form-control mb-3" rows="3"></textarea>

    <button class="btn btn-success w-100 fw-bold" onclick="saveUpdate()">SIMPAN & HANTAR</button>
  </div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// *** URL BACKEND BARU (SILA UPDATE) ***
const API = "https://script.google.com/macros/s/AKfycbx1hlsIWN5MCo7ab_ytT_d_oFqVjy1XMJwM39oBC8yPp9OLukRSbk47Ufate26quu4k/exec";
const FORM_URL = "https://script.google.com/macros/s/AKfycbz2hKf0rlCm8xWD_kXwEi0kYiVCOtcX1_noM6S0dHjkDJOrG6LtQ3GGt-4TT0plWVm60g/exec";

// GLOBAL VARS
let user = null;
let rawTasks = []; 
let taskHeaders = []; // HEADER PENTING
let pestList = {};
let keepImgs = [];

// INIT
document.getElementById('ifr').src = FORM_URL;
const saved = localStorage.getItem('pnr_user');
if(saved) { user = JSON.parse(saved); initApp(); }

// APP LOGIC
function initApp() {
  document.getElementById('loginOverlay').style.display='none';
  document.getElementById('uName').innerText = user.name;
  if(user.role === 'ADMIN' || user.role === 'PENYELIA') document.getElementById('navVer').style.display='block';
  document.getElementById('navTask').style.display='block';
  loadDash();
  loadTasks();
  fetch(API + "?action=getPestData").then(r=>r.json()).then(d=>pestList=d); // Preload pest
}

async function api(act, data={}) {
  const pl = { action:act, u:user.u, token:user.token, ...data };
  const r = await fetch(API, {method:'POST', body:JSON.stringify(pl)});
  return await r.json();
}

async function doLogin() {
  const u = document.getElementById('uid').value;
  const p = document.getElementById('pwd').value;
  const r = await api('login', {u,p});
  if(r.success) {
    user = { ...r, u: u }; 
    localStorage.setItem('pnr_user', JSON.stringify(user));
    initApp();
  } else document.getElementById('loginMsg').innerText = r.message;
}

function logout() { localStorage.removeItem('pnr_user'); location.reload(); }
function nav(id) {
  ['view-main','view-tasks','view-verify','view-form'].forEach(d=>document.getElementById(d).style.display='none');
  document.getElementById('view-'+id).style.display='block';
  if(id==='verify') loadVerify();
  if(id==='tasks') loadTasks();
}

// --- DASHBOARD (RINGKAS) ---
async function loadDash() {
  const r = await api('getAnalytics', {state: user.state});
  if(r.records) {
    let tt=0, ts=0;
    const b = document.getElementById('tbMain'); b.innerHTML="";
    r.records.forEach(d => {
      tt += d.lt; ts += d.ls;
      b.innerHTML += `<tr><td>${d.t}</td><td>${d.n}<br><small>${d.l}</small></td><td>${d.tn}</td><td class="text-danger fw-bold">${d.ls.toFixed(2)}</td><td><button class="btn btn-sm btn-outline-primary" onclick='viewRec(${JSON.stringify(d)})'>Lihat</button></td></tr>`;
    });
    document.getElementById('k1').innerText = tt.toFixed(2);
    document.getElementById('k2').innerText = ts.toFixed(2);
    document.getElementById('k3').innerText = tt>0 ? (ts/tt*100).toFixed(1)+"%" : "0%";
    document.getElementById('k4').innerText = r.records.length;
  }
}
function viewRec(d) { alert("Lihat butiran ID: " + d.id); }

// --- 1. LOAD TASKS (DENGAN HEADER MAPPING PINTAR) ---
async function loadTasks() {
  nav('tasks');
  const c = document.getElementById('taskContainer'); 
  c.innerHTML = "Loading...";
  
  const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'getMyTasks', name:user.name})}).then(res=>res.json());
  
  if(r.rows && r.rows.length) {
    rawTasks = r.rows;
    taskHeaders = r.headers; // SIMPAN HEADER NI
    c.innerHTML = "";
    document.getElementById('badgeTask').innerText = r.rows.length;

    // Helper cari value guna nama header (Dynamic Mapping)
    const get = (rowArr, keys) => {
       const idx = taskHeaders.findIndex(h => keys.some(k => h.includes(k)));
       return idx > -1 ? rowArr[idx] : "";
    };

    rawTasks.forEach((t, i) => {
       const d = t.data;
       c.innerHTML += `
       <div class="col-md-6 mb-3"><div class="verify-card p-3 border-danger border-start border-4">
         <h6 class="fw-bold">${get(d, ["LOKASI","KEBUN"])}</h6>
         <div class="small text-muted">${get(d, ["TANAMAN"])} | ${formatDate(get(d, ["TARIKH","DATE"]))}</div>
         <div class="alert alert-danger py-1 px-2 mt-2 small">Sebab: ${get(d, ["LOG","CATATAN"]) || "-"}</div>
         <button class="btn btn-danger w-100 btn-sm fw-bold" onclick="editTask(${i})">KEMASKINI</button>
       </div></div>`;
    });
  } else {
    c.innerHTML = "Tiada tugasan.";
  }
}

// --- 2. BUKA MODAL EDIT (AUTO FILL) ---
function editTask(idx) {
  const t = rawTasks[idx];
  const d = t.data;
  
  // Fungsi Helper: Cari value berdasarkan array keys
  const get = (keys) => {
     const i = taskHeaders.findIndex(h => keys.some(k => h.includes(k)));
     return i > -1 ? d[i] : "";
  };

  // Populate Field Asas
  document.getElementById('e_row').value = t.row;
  document.getElementById('e_neg').value = get(["NEGERI"]);
  document.getElementById('e_dae').value = get(["DAERAH"]);
  document.getElementById('e_lok').value = get(["LOKASI","KEBUN"]);
  document.getElementById('e_date').value = formatDate(get(["TARIKH","DATE"]));
  document.getElementById('e_gps').value = get(["KOORDINAT","GPS"]);
  
  document.getElementById('e_cat').value = get(["KATEGORI"]);
  document.getElementById('e_crop').value = get(["TANAMAN"]); // Cari TANAMAN shj (bukan LUAS TANAMAN)
  document.getElementById('e_var').value = get(["VARIETI"]);
  document.getElementById('e_ha').value = get(["LUAS BERTANAM","LUAS"]);
  document.getElementById('e_syor').value = get(["SYOR"]);
  
  // Populate Caption (Cari column KETERANGAN atau CAPTION)
  document.getElementById('e_cap').value = get(["KETERANGAN", "CAPTION"]);

  // Populate Pest (JSON Parse)
  const tb = document.querySelector('#tbPest tbody'); tb.innerHTML="";
  let ls={}, sev={};
  try { ls = JSON.parse(get(["LUAS SERANGAN"])||"{}"); } catch(e){}
  try { sev = JSON.parse(get(["KETERUKAN"])||"{}"); } catch(e){}
  
  // Populate dropdown perosak
  const cat = get(["KATEGORI"]); const tan = get(["TANAMAN"]);
  const sel = document.getElementById('selPest'); sel.innerHTML='<option value="">- Pilih -</option>';
  if(pestList[cat] && pestList[cat][tan]) pestList[cat][tan].forEach(p => sel.innerHTML+=`<option value="${p}">${p}</option>`);

  Object.keys(ls).forEach(k => addPestRow(k, ls[k], sev[k]));

  // Populate Images (Split string, render as buttons)
  keepImgs = [];
  const rawImg = get(["IMAGE","GAMBAR"]);
  if(rawImg) keepImgs = String(rawImg).split(',').map(s=>s.trim()).filter(s=>s.startsWith('http'));
  renderImgs();

  new bootstrap.Modal(document.getElementById('mdlEdit')).show();
}

// --- 3. RENDER GAMBAR (JENIS BUTTON - BUKAN THUMBNAIL) ---
function renderImgs() {
  const c = document.getElementById('listImg'); c.innerHTML="";
  keepImgs.forEach((url, i) => {
    // FORCE LINK VIEW
    let viewUrl = url;
    if(url.includes("drive.google.com") && !url.includes("/view")) {
       const id = url.match(/[-\w]{25,}/);
       if(id) viewUrl = `https://drive.google.com/file/d/${id[0]}/view?usp=sharing`;
    }

    c.innerHTML += `
    <div class="img-btn-row">
       <a href="${viewUrl}" target="_blank" class="btn btn-sm btn-outline-primary fw-bold text-truncate" style="max-width:250px">
         <i class="bi bi-eye"></i> Lihat Gambar ${i+1}
       </a>
       <button class="btn btn-sm btn-outline-danger" onclick="delImg(${i})"><i class="bi bi-trash"></i></button>
    </div>`;
  });
}
function delImg(i) { if(confirm("Padam gambar?")) { keepImgs.splice(i,1); renderImgs(); } }

function addPestRow(n="", a="", s="1") {
  const name = n || document.getElementById('selPest').value;
  if(!name) return;
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><input class="form-control form-control-sm p-name" value="${name}" readonly></td>
  <td><input type="number" class="form-control form-control-sm p-area" value="${a}" step="0.01"></td>
  <td><select class="form-select form-select-sm p-sev"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></td>
  <td><i class="bi bi-x text-danger" onclick="this.closest('tr').remove()" style="cursor:pointer"></i></td>`;
  tr.querySelector('.p-sev').value = s;
  document.querySelector('#tbPest tbody').appendChild(tr);
}
function addPest() { addPestRow(); }

// --- 4. SAVE UPDATE (TERMASUK CAPTION) ---
async function saveUpdate() {
  if(!confirm("Hantar?")) return;
  const btn = event.target; btn.innerHTML="Menghantar..."; btn.disabled=true;

  // New Images
  const newImgs = [];
  const files = document.getElementById('e_file').files;
  if(files.length) {
    for(let f of files) {
      const b64 = await new Promise(r=>{const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f)});
      newImgs.push({name:f.name, dataUrl:b64});
    }
  }

  // Pest Data
  const ls={}, sev={}, pct={}; 
  const lt = parseFloat(document.getElementById('e_ha').value)||0;
  document.querySelectorAll('#tbPest tbody tr').forEach(tr => {
     const n = tr.querySelector('.p-name').value;
     const a = parseFloat(tr.querySelector('.p-area').value)||0;
     ls[n]=a; sev[n]=tr.querySelector('.p-sev').value; pct[n]=(lt>0?(a/lt*100).toFixed(2):0);
  });

  const payload = {
    action: 'updateEntry',
    row: document.getElementById('e_row').value,
    token: user.token, u: user.u, 
    
    // Data Field
    negeri: document.getElementById('e_neg').value,
    daerah: document.getElementById('e_dae').value,
    lokasi: document.getElementById('e_lok').value,
    tarikh: document.getElementById('e_date').value,
    coord: document.getElementById('e_gps').value,
    kategori: document.getElementById('e_cat').value,
    tanaman: document.getElementById('e_crop').value,
    varieti: document.getElementById('e_var').value,
    luasT: lt,
    syor: document.getElementById('e_syor').value,
    
    // JSON & Caption
    luasS: ls, keterukan: sev, peratus: pct,
    caption: document.getElementById('e_cap').value, // Hantar Caption
    
    // Images
    keptImages: keepImgs, newImages: newImgs
  };

  try {
    const r = await fetch(API, {method:'POST', body:JSON.stringify(payload)}).then(res=>res.json());
    if(r.success) { 
        alert("Berjaya!"); 
        bootstrap.Modal.getInstance(document.getElementById('mdlEdit')).hide();
        loadTasks(); 
    } else alert(r.message);
  } catch(e) { alert("Error: "+e); }
  
  btn.innerHTML="SIMPAN & HANTAR"; btn.disabled=false;
}

// --- VERIFY & UTILS ---
async function loadVerify() {
  const box = document.getElementById('verBox'); box.innerHTML="<div class='text-center p-4'>Loading...</div>";
  const r = await api('getPending', {state:user.state});
  if(r.rows && r.rows.length) {
    box.innerHTML="";
    const h = r.headers;
    const val = (d,k) => { const i=h.findIndex(x=>x.includes(k)); return i>-1?d[i]:""; };
    
    r.rows.forEach(item => {
      const d = item.data;
      const imgs = String(val(d,"IMAGE")||"").split(',').filter(x=>x.length>5);
      let imgBtns = "";
      imgs.forEach((u,i)=> imgBtns+=`<a href="${u}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-2 me-1">Img ${i+1}</a>`);
      
      box.innerHTML += `<div class="col-md-6"><div class="verify-card p-3 border-warning border-top border-4">
        <div class="d-flex justify-content-between mb-2">
           <small class="text-muted">${val(d,"TARIKH")}</small>
           <span class="badge bg-warning text-dark">BARU</span>
        </div>
        <h6 class="fw-bold">${val(d,"LOKASI")}</h6>
        <div class="small mb-2">${val(d,"TANAMAN")} (${val(d,"LUAS BERTANAM")} Ha)</div>
        <div class="bg-light p-2 rounded small mb-2">Serangan: ${val(d,"LUAS SERANGAN")}</div>
        <div class="mb-3">${imgBtns}</div>
        <div class="d-flex gap-2">
           <button class="btn btn-outline-danger flex-grow-1 btn-sm" onclick="subVer(${item.row},'REJECT')">TOLAK</button>
           <button class="btn btn-success flex-grow-1 btn-sm" onclick="subVer(${item.row},'APPROVE')">SAHKAN</button>
        </div>
      </div></div>`;
    });
  } else box.innerHTML="<div class='text-center p-4 text-muted'>Tiada data.</div>";
}

async function subVer(row, act) {
  let re=""; if(act==='REJECT'){re=prompt("Sebab:");if(!re)return;}
  await api('submitVerify',{row,act,reason:re,name:user.name});
  loadVerify(); loadDash();
}

function formatDate(d) { if(!d)return""; const dt=new Date(d); return isNaN(dt)?"":dt.toISOString().split('T')[0]; }
</script>
</body>
</html>
