<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Borang PNR Digital</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{background:#f3f4f6}
.container{max-width:720px;background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
.perosak-item{border:1px solid #e5e7eb;padding:15px;border-radius:10px;margin-bottom:15px;position:relative}
.preview-img{max-width:90px;max-height:90px;border:1px solid #ddd;border-radius:6px;object-fit:cover}
.loader{position:fixed;inset:0;background:rgba(255,255,255,.9);z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column}
</style>
</head>

<body>

<div class="loader" id="loader">
  <div class="spinner-border text-success"></div>
  <strong class="mt-2">Memproses...</strong>
</div>

<div class="container mt-4 mb-5">
<h3 class="text-success fw-bold text-center mb-4">üå± Borang Pemantauan PNR</h3>

<form id="pnrForm">

<!-- A. MAKLUMAT AM -->
<h5 class="text-primary border-bottom pb-2">A. Maklumat Am</h5>

<div class="mb-3">
<label class="fw-bold">Nama Pegawai</label>
<input list="userList" id="namaPegawai" class="form-control" required>
<datalist id="userList"></datalist>
</div>

<div class="mb-3">
<label class="fw-bold">Email</label>
<input type="email" id="email" class="form-control">
</div>

<div class="mb-3">
<label class="fw-bold">Tarikh Bancian</label>
<input type="date" id="tarikh" class="form-control" required>
</div>

<div class="row">
<div class="col-6 mb-3">
<label class="fw-bold">Negeri</label>
<select id="negeri" class="form-select" required></select>
</div>
<div class="col-6 mb-3">
<label class="fw-bold">Daerah</label>
<select id="daerah" class="form-select" required></select>
</div>
</div>

<div class="mb-3">
<label class="fw-bold">Lokasi / Kebun</label>
<input id="lokasi" class="form-control" required>
</div>

<div class="mb-3">
<label class="fw-bold">Koordinat GPS</label>
<div class="input-group">
<input id="koordinat" class="form-control">
<button class="btn btn-secondary" type="button" onclick="getLocation()">üìç</button>
</div>
</div>

<!-- B. TANAMAN -->
<h5 class="text-primary border-bottom pb-2 mt-4">B. Maklumat Tanaman</h5>

<div class="mb-3">
<label class="fw-bold">Kategori</label>
<select id="kategori" class="form-select" required></select>
</div>

<div class="row">
<div class="col-6 mb-3">
<label class="fw-bold">Tanaman</label>
<select id="tanaman" class="form-select" required></select>
</div>
<div class="col-6 mb-3">
<label class="fw-bold">Varieti</label>
<input id="varieti" class="form-control">
</div>
</div>

<div class="row">
<div class="col-6 mb-3">
<label class="fw-bold">Umur Tanaman</label>
<input id="umur" class="form-control">
</div>
<div class="col-6 mb-3">
<label class="fw-bold">Luas Bertanam (Ha)</label>
<input type="number" step="0.01" id="luasTanam" class="form-control" required oninput="recalcPct()">
</div>
</div>

<!-- C. PEROSAK -->
<h5 class="text-primary border-bottom pb-2 mt-4">C. Perosak & Penyakit</h5>
<datalist id="pestList"></datalist>

<div id="perosakContainer"></div>

<button type="button" class="btn btn-outline-primary w-100 mb-3" onclick="addPest()">+ Tambah Perosak</button>

<!-- D. SYOR -->
<div class="mb-3">
<label class="fw-bold text-success">Syor Kawalan</label>
<div id="syorBox" class="border rounded p-2" style="max-height:150px;overflow-y:auto"></div>
<textarea id="syorExtra" class="form-control mt-2" placeholder="Tambah syor lain..."></textarea>
</div>

<!-- E. GAMBAR -->
<h5 class="text-primary border-bottom pb-2 mt-4">D. Gambar</h5>

<div class="mb-2">
<input id="caption" class="form-control" placeholder="Keterangan gambar (max 30)">
</div>

<div class="mb-3">
<input type="file" id="images" multiple class="form-control" onchange="previewImages()">
<div id="preview" class="d-flex flex-wrap mt-2 gap-2"></div>
</div>

<button class="btn btn-success w-100 fw-bold py-2" type="submit">
HANTAR LAPORAN
</button>

</form>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbx1hlsIWN5MCo7ab_ytT_d_oFqVjy1XMJwM39oBC8yPp9OLukRSbk47Ufate26quu4k/exec";

/* ================= STATE ================= */
let pestTree={}, syorList=[], users=[];
let files=[];

/* ================= INIT ================= */
window.onload = async ()=>{
  const ref = await api("getAllReferenceData");
  pestTree = ref.pestTree;
  syorList = ref.syorList;
  users = ref.userList;

  // User list
  const dl=document.getElementById("userList");
  users.forEach(u=>dl.appendChild(new Option(u,u)));

  // Negeri
  const negeriSel=document.getElementById("negeri");
  Object.keys(ref.districtData||{}).forEach(n=>negeriSel.add(new Option(n,n)));

  // Kategori
  const katSel=document.getElementById("kategori");
  katSel.innerHTML="<option value=''>- Pilih -</option>";
  Object.keys(pestTree).sort().forEach(k=>katSel.add(new Option(k,k)));

  // Syor
  const sb=document.getElementById("syorBox");
  syorList.forEach(s=>{
    sb.innerHTML+=`<div class="form-check">
      <input class="form-check-input syor" type="checkbox" value="${s}">
      <label class="form-check-label">${s}</label>
    </div>`;
  });

  addPest();
};

/* ================= UI ================= */
document.getElementById("kategori").onchange=()=>{
  const k=document.getElementById("kategori").value;
  const t=document.getElementById("tanaman");
  t.innerHTML="<option value=''>- Pilih -</option>";
  if(pestTree[k]) Object.keys(pestTree[k]).forEach(x=>t.add(new Option(x,x)));
};

document.getElementById("tanaman").onchange=()=>{
  const k=document.getElementById("kategori").value;
  const t=document.getElementById("tanaman").value;
  const dl=document.getElementById("pestList");
  dl.innerHTML="";
  if(pestTree[k]&&pestTree[k][t]){
    pestTree[k][t].forEach(p=>dl.appendChild(new Option(p,p)));
  }
};

function addPest(){
  const div=document.createElement("div");
  div.className="perosak-item";
  div.innerHTML=`
  <button type="button" class="btn-close position-absolute top-0 end-0 m-2"
    onclick="this.parentElement.remove()"></button>
  <input list="pestList" class="form-control mb-2 pname" placeholder="Perosak">
  <div class="row g-2">
    <div class="col-4"><input type="number" step="0.01" class="form-control luas" placeholder="Luas" oninput="calc(this)"></div>
    <div class="col-4"><input class="form-control pct" readonly placeholder="%"></div>
    <div class="col-4">
      <select class="form-select sev">
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
    </div>
  </div>`;
  document.getElementById("perosakContainer").appendChild(div);
}

function calc(el){
  const luasT=parseFloat(luasTanam.value)||0;
  const luasS=parseFloat(el.value)||0;
  el.parentElement.parentElement.querySelector(".pct").value=
    luasT>0?((luasS/luasT)*100).toFixed(2):0;
}
function recalcPct(){
  document.querySelectorAll(".luas").forEach(calc);
}

/* ================= IMAGE ================= */
function previewImages(){
  files=[...images.files];
  preview.innerHTML="";
  files.forEach(f=>{
    const r=new FileReader();
    r.onload=e=>preview.innerHTML+=`<img src="${e.target.result}" class="preview-img">`;
    r.readAsDataURL(f);
  });
}

/* ================= GPS ================= */
function getLocation(){
  navigator.geolocation.getCurrentPosition(p=>{
    koordinat.value=p.coords.latitude.toFixed(5)+", "+p.coords.longitude.toFixed(5);
  });
}

/* ================= SUBMIT ================= */
pnrForm.onsubmit=async e=>{
  e.preventDefault();
  loader.style.display="flex";

  const luasS={}, pctS={}, sevS={}, names=[];
  document.querySelectorAll(".perosak-item").forEach(r=>{
    const n=r.querySelector(".pname").value;
    if(n){
      names.push(n);
      luasS[n]=parseFloat(r.querySelector(".luas").value)||0;
      pctS[n]=r.querySelector(".pct").value||0;
      sevS[n]=r.querySelector(".sev").value;
    }
  });

  const imgs = await Promise.all(files.map(f=>new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res({name:f.name,dataUrl:r.result});
    r.readAsDataURL(f);
  })));

  const payload={
    namaPegawai:namaPegawai.value,
    email:email.value,
    tarikhBancian:tarikh.value,
    negeri:negeri.value,
    daerah:daerah.value,
    lokasi:lokasi.value,
    koordinat:koordinat.value,
    kategori:kategori.value,
    namaTanaman:tanaman.value,
    varieti:varieti.value,
    umurTanaman:umur.value,
    luasBertanam:luasTanam.value,
    senaraiPerosak:names.join(", "),
    luasSerangan:luasS,
    peratusSerangan:pctS,
    keterukan:sevS,
    syor:[...document.querySelectorAll(".syor:checked")].map(x=>x.value).join("; "),
    images:JSON.stringify(imgs),
    captionGambar:caption.value
  };

  await api("submitData",payload);
  loader.style.display="none";

  Swal.fire("Berjaya","Data berjaya dihantar","success")
    .then(()=>window.parent?.postMessage("BORANG_SELESAI","*"));
};

/* ================= API ================= */
async function api(action,data={}){
  const r=await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action,...data})
  });
  return r.json();
}
</script>

</body>
</html>
