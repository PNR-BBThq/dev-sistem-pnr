<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem PNR Digital - FINAL FIXED</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

    <style>
        :root { --primary: #064e3b; --accent: #10b981; --bg: #f3f4f6; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; margin:0; }
        
        /* LOGIN & LAYOUT */
        #loginOverlay { position: fixed; inset: 0; z-index: 999999; display: flex; align-items: center; justify-content: center; background: #064e3b; }
        .login-box { background: white; padding: 2.5rem; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .sidebar { width: 260px; height: 100vh; position: fixed; top: 0; left: 0; background: #e8f5e9; border-right: 1px solid #c6e7ce; padding: 20px; z-index: 100; transition: transform 0.3s; display: flex; flex-direction: column; }
        .brand { font-size: 1.3rem; font-weight: 900; color: #000; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; padding-left: 10px; flex-shrink: 0; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding-right: 5px; margin-bottom: 10px; }
        .sidebar-content::-webkit-scrollbar { width: 4px; }
        .sidebar-content::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: #000; font-weight: 600; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .nav-item:hover { background: #c8e6c9; color: #000; }
        .nav-item.active { background: #1b5e20; color: white; font-weight: 700; }
        .sidebar-footer { flex-shrink: 0; border-top: 1px solid #c6e7ce; padding-top: 15px; }
        .main-content { margin-left: 260px; padding: 25px; transition: margin-left 0.3s; }
        
        /* DASHBOARD CARDS */
        .kpi-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid #e5e7eb; height: 100%; transition: transform 0.2s; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: #111827; margin-top: 5px; }
        .map-box { height: 400px; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb; position: relative; z-index: 1; }
        .table-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; overflow: hidden; }
        .text-danger { color: #dc2626 !important; }
        .badge-pending { background: #dc2626; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; display: none; }

        /* --- STYLE REPORT CARD --- */
        .verify-card { background: #fff; border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; height: 100%; display: flex; flex-direction: column; transition: transform 0.2s; border: 1px solid #e2e8f0; }
        .verify-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .verify-header { background: #f8f9fa; border-bottom: 1px solid #e9ecef; padding: 15px 20px; display: flex; justify-content: space-between; align-items: flex-start; }
        .verify-body { padding: 20px; flex-grow: 1; }
        .verify-footer { background: #fff; border-top: 1px solid #e9ecef; padding: 15px; display: flex; gap: 10px; }
        
        .section-title { font-size: 0.8rem; font-weight: 800; text-transform: uppercase; color: var(--primary); margin: 15px 0 8px 0; border-bottom: 1px dashed #dee2e6; padding-bottom: 4px; display: flex; align-items: center; gap: 5px; }
        .section-title:first-child { margin-top: 0; }
        
        .v-row { display: flex; margin-bottom: 6px; font-size: 0.9rem; align-items: flex-start; border-bottom: 1px solid #f1f5f9; padding-bottom: 4px;}
        .v-label { width: 130px; font-weight: 700; color: #000; flex-shrink: 0; font-size: 0.85rem; }
        .v-val { flex-grow: 1; color: #1e293b; font-weight: 500; word-break: break-word; }
        
        /* TABLE MINI DALAM KAD */
        .mini-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; margin-top: 5px; margin-bottom: 15px; }
        .mini-table th { background: #f1f5f9; text-transform: uppercase; font-size: 0.7rem; color: #475569; padding: 8px; border: 1px solid #e2e8f0; font-weight: 800; }
        .mini-table td { padding: 8px; border: 1px solid #e2e8f0; vertical-align: middle; }
        .mini-table td.center { text-align: center; }
        
        .syor-box { background-color: #fffbeb; border: 1px solid #fde68a; padding: 10px; border-radius: 6px; font-size: 0.85rem; color: #92400e; display: flex; gap: 8px; align-items: flex-start; }

        .filter-label { font-size: 0.75rem; font-weight: 800; color: #000; margin-bottom: 3px; display: block; text-transform: uppercase; }

        /* STYLE KHAS UNTUK TUGASAN */
        .task-reject-box { background-color: #fef2f2; border: 1px solid #fecaca; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #b91c1c; }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <div class="brand justify-content-center mb-4"><i class="bi bi-flower1"></i> PNR DIGITAL</div>
            <h6 class="text-muted mb-4">Log Masuk Sistem</h6>
            <input type="text" id="uid" class="form-control mb-3 p-3" placeholder="ID Pengguna">
            <input type="password" id="pwd" class="form-control mb-4 p-3" placeholder="Kata Laluan">
            <button type="button" onclick="doLogin()" class="btn btn-success w-100 fw-bold p-3" id="btnLogin">MASUK</button>
            <small id="loginMsg" class="text-danger d-block mt-3 fw-bold"></small>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="brand"><i class="bi bi-flower1"></i> PNR DIGITAL</div>
        
        <div class="sidebar-content">
            <div class="nav-item active" onclick="switchTab('main', this)">
                <span><i class="bi bi-grid-1x2-fill me-2"></i> Dashboard</span>
            </div>
            
            <div class="nav-item" id="navTasks" style="display:none" onclick="switchTab('tasks', this)">
                <span><i class="bi bi-list-task me-2"></i> Tugasan Saya</span>
                <span class="badge-pending" id="badgeTask" style="background:#dc2626;">0</span>
            </div>

            <div class="nav-item" id="navVerify" style="display:none" onclick="switchTab('verify', this)">
                <span><i class="bi bi-check-circle-fill me-2"></i> Pengesahan</span>
                <span class="badge-pending" id="badgePending">0</span>
            </div>
            <hr class="my-4" style="color: #000;">
            
            <div class="mb-3 px-2">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <small class="fw-bold text-dark" style="font-size:0.85rem; letter-spacing: 0.5px;"><i class="bi bi-funnel-fill me-1"></i> TAPISAN DATA</small>
                </div>
                
                <div class="mb-2"><label class="filter-label">Negeri</label><select id="selNegeri" class="form-select form-select-sm" onchange="runFilter('n')"></select></div>
                <div class="mb-2"><label class="filter-label">Daerah</label><select id="selDaerah" class="form-select form-select-sm" onchange="runFilter('d')"></select></div>
                <div class="mb-2"><label class="filter-label">Tanaman</label><select id="selTanaman" class="form-select form-select-sm" onchange="runFilter('t')"></select></div>
                <div class="mb-2"><label class="filter-label">Perosak</label><select id="selPerosak" class="form-select form-select-sm" onchange="runFilter('p')"></select></div>
                <div class="mb-2"><label class="filter-label">Kategori</label><select id="selKategori" class="form-select form-select-sm" onchange="runFilter('k')"></select></div>
                
                <div class="mb-3">
                    <label class="filter-label">Julat Tarikh</label>
                    <div class="row g-1">
                        <div class="col-6"><input type="date" id="dS" class="form-control form-control-sm" onchange="runFilter()"></div>
                        <div class="col-6"><input type="date" id="dE" class="form-control form-control-sm" onchange="runFilter()"></div>
                    </div>
                </div>
                
                <button class="btn btn-dark btn-sm w-100" onclick="resetFilter()">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset Tapisan
                </button>

                <hr class="my-4" style="color:#000">

                <div class="p-3 rounded border shadow-sm bg-white">
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-danger text-white rounded p-1 me-2"><i class="bi bi-bug-fill"></i></div>
                        <small class="fw-bold text-dark" style="line-height:1.2">Pemantauan<br>Perangkap RPW</small>
                    </div>
                    <p class="text-muted mb-2" style="font-size: 0.75rem;">Akses pantas ke data perangkap kumbang.</p>
                    <button onclick="window.open(RPW_URL, '_blank')" class="btn btn-outline-danger btn-sm w-100 fw-bold">
                        <i class="bi bi-box-arrow-up-right"></i> Buka Sistem
                    </button>
                </div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div class="nav-item mb-3 bg-success text-white shadow-sm" onclick="switchTab('form', this)" style="cursor: pointer;">
                <span><i class="bi bi-plus-lg me-2"></i> Tambah Data</span>
            </div>

            <div class="d-flex align-items-center justify-content-between px-2">
                <div><small class="text-dark d-block" style="font-size: 0.75rem; font-weight:600;">Pengguna</small><strong id="uDisp" class="text-dark" style="font-size:0.9rem">-</strong></div>
                <button class="btn btn-link text-danger btn-sm p-0" onclick="doLogout()" title="Log Keluar"><i class="bi bi-box-arrow-right fs-5"></i></button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="d-md-none mb-3 d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm">
            <span class="fw-bold text-success fs-5"><i class="bi bi-flower1"></i> PNR</span>
            <button class="btn btn-light btn-sm border" onclick="document.getElementById('sidebar').classList.toggle('active')"><i class="bi bi-list fs-5"></i></button>
        </div>

        <div id="view-main">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                <div><h4 class="fw-bold m-0 text-dark">Analisis Data</h4><small class="text-muted" id="lastUpdate">Data setakat: Terkini</small></div>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-white border bg-white text-secondary btn-sm px-3" onclick="initDash()"><i class="bi bi-arrow-clockwise"></i></button>
                    <button class="btn btn-success btn-sm px-3" onclick="downloadDualExcel()"><i class="bi bi-file-earmark-excel me-1"></i> Excel</button>
                    <button class="btn btn-danger btn-sm px-3" onclick="dlPDF()"><i class="bi bi-file-earmark-pdf me-1"></i> PDF</button>
                </div>
            </div>
            
            <div class="card mb-4 border-0 shadow-sm" style="background: linear-gradient(to right, #e0f2fe, #f0f9ff);">
                <div class="card-body p-4">
                    <div id="smartSummary" class="text-dark">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                            Sedang menganalisis data...
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="kpi-title">Luas Bancian</span><div class="kpi-icon bg-success-subtle text-success"><i class="bi bi-rulers"></i></div></div><div class="kpi-value" id="k1">0</div><small class="text-muted fw-bold">Hektar</small></div></div>
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="kpi-title">Luas Serangan</span><div class="kpi-icon bg-danger-subtle text-danger"><i class="bi bi-bug-fill"></i></div></div><div class="kpi-value text-danger" id="k2">0</div><small class="text-muted fw-bold">Hektar</small></div></div>
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="kpi-title">Peratus Serangan</span><div class="kpi-icon bg-warning-subtle text-warning"><i class="bi bi-percent"></i></div></div><div class="kpi-value" id="k3">0%</div><small class="text-muted fw-bold">Kadar Jangkitan</small></div></div>
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="kpi-title">Bil. Rekod</span><div class="kpi-icon bg-primary-subtle text-primary"><i class="bi bi-file-text"></i></div></div><div class="kpi-value" id="k4">0</div><small class="text-muted fw-bold">Unit Data</small></div></div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-8">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-header bg-transparent border-0 pt-4 px-4 pb-0"><h6 class="fw-bold text-secondary m-0">Carta Serangan Perosak Tertinggi (Ha)</h6></div>
                        <div class="card-body px-4 pb-4"><div style="height: 350px"> <canvas id="cBar"></canvas> </div></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-header bg-transparent border-0 py-3 d-flex align-items-center px-4 pt-4">
                            <div class="icon-shape bg-warning text-white rounded-3 p-2 me-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="bi bi-pie-chart-fill"></i></div>
                            <h6 class="m-0 fw-bold text-secondary">Tahap Keterukan</h6>
                        </div>
                        <div class="card-body text-center position-relative px-4 pb-4">
                            <div style="height: 250px;"><canvas id="cPie"></canvas></div>
                            <div class="mt-4 pt-3 border-top">
                                <p class="text-uppercase text-muted fw-bold mb-2" style="font-size: 10px; letter-spacing: 1px;">Petunjuk Tahap</p>
                                <div class="d-flex flex-wrap justify-content-center gap-2" style="font-size: 11px;">
                                    <span class="badge rounded-pill bg-success bg-opacity-75 text-white">T1: Sgt Rendah</span>
                                    <span class="badge rounded-pill bg-info text-dark">T2: Rendah</span>
                                    <span class="badge rounded-pill bg-warning text-dark">T3: Sederhana</span>
                                    <span class="badge rounded-pill text-white" style="background-color: #fd7e14;">T4: Teruk</span>
                                    <span class="badge rounded-pill bg-danger text-white">T5: Sgt Teruk</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-8"><div class="map-box shadow-sm" id="map"></div></div>
                <div class="col-md-4">
                    <div class="table-box h-100 shadow-sm" style="max-height:400px; overflow-y:auto">
                        <h6 class="fw-bold mb-3 text-danger d-flex align-items-center"><i class="bi bi-fire me-2"></i>Hotspot Daerah</h6>
                        <table class="table table-hover small mb-0"><thead class="table-light sticky-top"><tr><th>Daerah</th><th class="text-end">Luas Serangan (Ha)</th></tr></thead><tbody id="hotspotTable"></tbody></table>
                    </div>
                </div>
            </div>

            <div class="table-box shadow-sm">
                <div class="d-flex justify-content-between mb-3"><h6 class="fw-bold"><i class="bi bi-table me-2"></i>Jadual Rekod</h6><small id="pgInfo" class="text-muted"></small></div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light"><tr><th>Tarikh</th><th>Negeri</th><th>Lokasi</th><th>Tanaman</th><th>Luas(S)</th><th>Tindakan</th></tr></thead>
                        <tbody id="tBody"></tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-2">
                    <button class="btn btn-sm btn-white border shadow-sm px-3" onclick="movePg(-1)">Prev</button>
                    <button class="btn btn-sm btn-white border shadow-sm px-3" onclick="movePg(1)">Next</button>
                </div>
            </div>
        </div>

        <div id="view-verify" style="display:none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold m-0 text-dark">Pengesahan Data</h4>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-success btn-sm px-3 fw-bold" onclick="approveAll()"><i class="bi bi-check-all me-1"></i> Sahkan Semua</button>
                    <button class="btn btn-primary btn-sm px-3" onclick="loadPend()"><i class="bi bi-arrow-clockwise me-1"></i> Refresh</button>
                </div>
            </div>
            
            <div id="bulkProgress" class="alert alert-info" style="display:none">
                <div class="d-flex justify-content-between mb-1"><small>Memproses...</small><small id="progText">0%</small></div>
                <div class="progress" style="height: 10px;"><div class="progress-bar bg-success" id="progBar" style="width: 0%"></div></div>
            </div>
            
            <div id="verifyContainer" class="row g-3">
                <div class="col-12 text-center p-5 text-muted bg-white rounded shadow-sm border border-dashed">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">Memuatkan senarai untuk disahkan...</p>
                </div>
            </div>
        </div>

        <div id="view-tasks" style="display:none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold m-0 text-dark">Tugasan Saya</h4>
                <button class="btn btn-primary btn-sm px-3" onclick="loadMyTasks()"><i class="bi bi-arrow-clockwise me-1"></i> Refresh</button>
            </div>
            <div id="taskContainer" class="row g-3">
                <div class="col-12 text-center p-5 text-muted bg-white rounded shadow-sm border border-dashed">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">Memuatkan tugasan...</p>
                </div>
            </div>
        </div>

        <div id="view-form" style="display:none; height: 100%;">
            <iframe id="frameBorang" src="" style="width: 100%; height: 85vh; border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" allow="geolocation" title="Borang Bancian"></iframe>
        </div>

    </div>

    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success text-white">
                    <h6 class="modal-title fw-bold" id="modalTitle"><i class="bi bi-card-heading me-2"></i>BUTIRAN REKOD</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="if(confirm('Tutup tanpa simpan?')) { this.closest('.modal').querySelector('.btn-close').click() } else { return false; }"></button>
                </div>
                <div class="modal-body bg-light p-4" id="detailBody">
                    </div>
                <div class="modal-footer bg-white">
                    <button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // *** SILA PASTE URL BACKEND TERBARU TUAN DI SINI ***
        const API_URL = "https://script.google.com/macros/s/AKfycbx1hlsIWN5MCo7ab_ytT_d_oFqVjy1XMJwM39oBC8yPp9OLukRSbk47Ufate26quu4k/exec"; 
        
        const BANCIAN_URL = "https://script.google.com/macros/s/AKfycbx1hlsIWN5MCo7ab_ytT_d_oFqVjy1XMJwM39oBC8yPp9OLukRSbk47Ufate26quu4k/exec";
        const RPW_URL = "https://www.appsheet.com/start/55b088df-3ec1-469a-b5c6-1fca48052906";
        document.getElementById('frameBorang').src = BANCIAN_URL;

        const districtData = {
            "Johor": ["Batu Pahat", "Johor Bahru", "Kluang", "Kota Tinggi", "Kulai", "Mersing", "Muar", "Pontian", "Segamat", "Tangkak"],
            "Kedah": ["Baling", "Bandar Baharu", "Kota Setar", "Kuala Muda", "Kubang Pasu", "Kulim", "Langkawi", "Padang Terap", "Pendang", "Pokok Sena", "Sik", "Yan"],
            "Kelantan": ["Bachok", "Gua Musang", "Jeli", "Kota Bharu", "Kuala Krai", "Machang", "Pasir Mas", "Pasir Puteh", "Tanah Merah", "Tumpat"],
            "Melaka": ["Alor Gajah", "Jasin", "Melaka Tengah"],
            "Negeri Sembilan": ["Jelebu", "Jempol", "Kuala Pilah", "Port Dickson", "Rembau", "Seremban", "Tampin"],
            "Pahang": ["Bentong", "Bera", "Cameron Highlands", "Jerantut", "Kuantan", "Lipis", "Maran", "Pekan", "Raub", "Rompin", "Temerloh"],
            "Perak": ["Bagan Datuk", "Batang Padang", "Hilir Perak", "Hulu Perak", "Kampar", "Kerian", "Kinta", "Kuala Kangsar", "Larut, Matang dan Selama", "Manjung", "Muallim", "Perak Tengah"],
            "Perlis": ["Perlis"],
            "Pulau Pinang": ["Barat Daya", "Seberang Perai Selatan", "Seberang Perai Tengah", "Seberang Perai Utara", "Timur Laut"],
            "Sabah": ["Beaufort", "Beluran", "Kalabakan", "Keningau", "Kinabatangan", "Kota Belud", "Kota Kinabalu", "Kota Marudu", "Kuala Penyu", "Kudat", "Kunak", "Lahad Datu", "Nabawan", "Papar", "Penampang", "Pitas", "Putatan", "Ranau", "Sandakan", "Semporna", "Sipitang", "Tambunan", "Tawau", "Telupid", "Tenom", "Tongod", "Tuaran"],
            "Sarawak": ["Asajaya", "Bau", "Belaga", "Beluru", "Betong", "Bintulu", "Bukit Mabong", "Dalat", "Daro", "Julau", "Kabong", "Kanowit", "Kapit", "Kuching", "Lawas", "Limbang", "Lubok Antu", "Lundu", "Marudi", "Matu", "Meradong", "Miri", "Mukah", "Pakan", "Pusa", "Samarahan", "Saratok", "Sarikei", "Sebauh", "Selangau", "Serian", "Sibu", "Simunjan", "Song", "Sri Aman", "Subis", "Tanjung Manis", "Tatau", "Tebedu", "Telang Usan"],
            "Selangor": ["Gombak", "Hulu Langat", "Hulu Selangor", "Klang", "Kuala Langat", "Kuala Selangor", "Petaling", "Sabak Bernam", "Sepang"],
            "Terengganu": ["Besut", "Dungun", "Hulu Terengganu", "Kemaman", "Kuala Nerus", "Kuala Terengganu", "Marang", "Setiu"],
            "W.P. Kuala Lumpur": ["Kuala Lumpur"], "W.P. Labuan": ["Labuan"], "W.P. Putrajaya": ["Putrajaya"]
        };

        let mData=[], fData=[], uProf=null, map=null, layer=null, pg=1, pSize=10, charts={};
        let currentPendingRows = [];
        let myTasksData = [];
        let myTasksHeaders = []; // [PENTING] Untuk Smart Mapping
        let refPestData = null;
        let keptImages = [];

        // --- FETCHING ---
        async function postData(act, load) {
            try {
                let payload = { action: act, ...load };
                if (act !== 'login') {
                    payload.token = uProf ? uProf.token : "";
                    payload.u = uProf ? (uProf.username || uProf.u) : "";
                }
                const res = await fetch(`${API_URL}?action=${act}`, {
                    method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(payload)
                });
                const r = JSON.parse(await res.text());
                if (r.success === false && r.message && String(r.message).toLowerCase().includes("sesi")) {
                    alert("⛔ Sesi tamat. Sila log masuk semula."); localStorage.removeItem('pnr_session'); location.reload();
                }
                return r;
            } catch(e) { console.error(e); return {success:false, message:"Ralat sambungan."}; }
        }

        async function loadRefData() {
            if(refPestData) return;
            try { const res = await fetch(API_URL + "?action=getPestData"); refPestData = await res.json(); } catch(e){}
        }

        // --- LOGIN ---
        async function doLogin() {
            const u = document.getElementById('uid').value.trim();
            const p = document.getElementById('pwd').value.trim();
            if(!u || !p) { document.getElementById('loginMsg').innerText = "Sila isi ID dan Kata Laluan"; return; }
            document.getElementById('btnLogin').innerText = "Memproses...";
            const r = await postData('login', {u, p});
            if(r.success) {
                r.username = u;
                localStorage.setItem('pnr_session', JSON.stringify({ uProf: r, userToken: r.token, currentUserID: u }));
                applyLogin(r);
            } else {
                document.getElementById('loginMsg').innerText = r.message; document.getElementById('btnLogin').innerText = "MASUK";
            }
        }

        function applyLogin(r) {
            uProf = r;
            if(!uProf.username) uProf.username = r.u || r.name; // Fallback
            document.getElementById('uDisp').innerText = r.name;
            document.getElementById('loginOverlay').style.display = 'none';
            if(["ADMIN","PENYELIA"].includes((r.role||"").toUpperCase())) { document.getElementById('navVerify').style.display = "flex"; checkPendingCount(); }
            document.getElementById('navTasks').style.display = "flex";
            loadMyTasks(); initDash(); loadRefData();
        }

        window.onload = function() {
            const saved = localStorage.getItem('pnr_session');
            if(saved) { try { const s = JSON.parse(saved); if(s.uProf) applyLogin(s.uProf); } catch(e){} }
        }
        function doLogout() { localStorage.removeItem('pnr_session'); location.reload(); }

        function switchTab(t, el) {
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if(el) el.classList.add('active');
            ['view-main','view-tasks','view-verify','view-form'].forEach(v => document.getElementById(v).style.display = (v === 'view-'+t ? 'block' : 'none'));
            if(t==='verify') loadPend();
            if(t==='tasks') loadMyTasks();
            if(t==='main' && map) setTimeout(() => map.invalidateSize(), 300);
        }

        // --- DASHBOARD ---
        async function checkPendingCount() { try { const d = await postData('getPending', {state: uProf.state}); const b = document.getElementById('badgePending'); b.innerText = (d.rows||[]).length; b.style.display = d.rows && d.rows.length ? "inline-block" : "none"; } catch(e){} }

        async function initDash() {
            const d = await postData('getAnalytics', {state: uProf.state});
            if(d.records) {
                mData = d.records;
                const sel = document.getElementById('selNegeri');
                const cur = sel.value;
                sel.innerHTML = '<option value="">Semua</option>';
                [...new Set(mData.map(x=>x.n))].sort().forEach(x=> sel.innerHTML+=`<option value="${x}">${x}</option>`);
                if(cur) sel.value = cur;
                if(uProf.state !== "ALL") { sel.value = uProf.state; sel.disabled = true; }
                if(!map) { map = L.map('map').setView([4.2105, 101.9758], 6); L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map); }
                runFilter('n');
            }
        }

        function runFilter(src) {
            const n=v('selNegeri'), d=v('selDaerah'), t=v('selTanaman');
            fData = mData.filter(r => (n===""||r.n===n) && (d===""||r.d===d) && (t===""||r.t===t)); // Simplified filter logic
            // ... Re-use previous logic for dropdown updates ...
            if(src==='n') updateDropdown('selDaerah', [...new Set(fData.map(x=>x.d))].sort());
            calcUI();
        }
        function updateDropdown(id, list) { const el=document.getElementById(id); el.innerHTML='<option value="">Semua</option>'; list.forEach(x=>el.innerHTML+=`<option value="${x}">${x}</option>`); }
        function v(id){ return document.getElementById(id).value; }

        function calcUI() {
            let tt=0, ts=0; fData.forEach(r=>{ tt+=r.lt||0; ts+=r.ls||0; });
            document.getElementById('k1').innerText = tt.toFixed(2);
            document.getElementById('k2').innerText = ts.toFixed(2);
            document.getElementById('k3').innerText = tt>0?(ts/tt*100).toFixed(1)+'%':'0%';
            document.getElementById('k4').innerText = fData.length;
            renTab();
        }
        function renTab() {
            const b = document.getElementById('tbMain'); b.innerHTML = "";
            fData.slice((pg-1)*10, pg*10).forEach((d,i)=> b.innerHTML+=`<tr><td>${d.t}</td><td>${d.n}<br><small>${d.l}</small></td><td>${d.tn}</td><td class="text-danger fw-bold">${d.ls.toFixed(2)}</td><td><button class="btn btn-sm btn-outline-primary" onclick='viewRec(${JSON.stringify(d)})'>Lihat</button></td></tr>`);
            document.getElementById('pgInfo').innerText = "Page "+pg;
        }
        function movePg(x) { pg+=x; if(pg<1)pg=1; renTab(); }

        // --- FUNGSI EDIT & TUGASAN (DIPERBAIKI SECARA BESAR-BESARAN) ---

        async function loadMyTasks() {
            const c = document.getElementById('taskContainer'); c.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';
            const d = await postData('getMyTasks', { name: uProf.name });
            myTasksData = d.rows || [];
            myTasksHeaders = (d.headers || []).map(h => String(h).toUpperCase()); // SIMPAN HEADER
            
            document.getElementById('badgeTask').innerText = myTasksData.length;
            document.getElementById('badgeTask').style.display = myTasksData.length ? 'inline-block' : 'none';

            if (!myTasksData.length) { c.innerHTML = '<div class="col-12 text-center p-5 text-muted border rounded">Tiada tugasan.</div>'; return; }

            c.innerHTML = "";
            myTasksData.forEach(r => {
                // Guna Smart Find (Cari ikut nama header, bukan nombor index)
                const get = (k) => { const i = myTasksHeaders.findIndex(h => h.includes(k)); return i > -1 ? r.data[i] : ""; };
                
                c.innerHTML += `
                <div class="col-md-6 col-xl-4">
                    <div class="verify-card bg-white rounded-3 shadow-sm border mb-3 border-danger">
                        <div class="p-3 border-bottom bg-danger bg-opacity-10 d-flex justify-content-between">
                            <div>
                                <div class="fw-bold text-dark">${get("LOKASI") || get("KEBUN")}</div>
                                <div class="small text-muted">${get("TANAMAN")}</div>
                                <div class="small text-muted">${formatDateForInput(get("TARIKH") || get("DATE"))}</div>
                            </div>
                            <span class="badge bg-danger">DITOLAK</span>
                        </div>
                        <div class="p-3">
                            <div class="task-reject-box small mb-2"><strong>Sebab:</strong> ${get("LOG") || get("CATATAN") || "Sila semak"}</div>
                            <button class="btn btn-danger w-100 fw-bold btn-sm" onclick="openTaskEdit(${r.row})">KEMASKINI</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        // PENGENDALIAN EDIT FORM PINTAR (AUTO-FILL)
        async function openTaskEdit(rowId) {
            if(!refPestData) await loadRefData();
            const task = myTasksData.find(t => t.row === rowId);
            if(!task) return alert("Data error.");

            // FUNGSI PINTAR: Cari data berdasarkan header
            const rData = task.data;
            const h = myTasksHeaders; 
            
            // Helper function untuk ambil value berdasarkan kata kunci header
            const val = (keys) => {
                if(!Array.isArray(keys)) keys = [keys];
                const idx = h.findIndex(hdr => keys.some(k => hdr.includes(k)));
                return idx > -1 ? rData[idx] : "";
            };

            // 1. Ambil Data
            const d = {
                row: rowId,
                pegawai: val(["NAMA", "PEGAWAI"]),
                tarikh: formatDateForInput(val(["TARIKH", "DATE"])),
                negeri: val("NEGERI"),
                daerah: val("DAERAH"),
                lokasi: val(["LOKASI", "KEBUN"]),
                coord: val(["KOORDINAT", "GPS"]),
                kategori: val("KATEGORI"),
                tanaman: val(["NAMA TANAMAN", "JENIS TANAMAN"]),
                varieti: val("VARIETI"),
                luasT: val(["LUAS BERTANAM", "LUAS TANAMAN"]),
                luasS: val("LUAS SERANGAN"), 
                keterukan: val("KETERUKAN"), 
                syor: val(["SYOR", "KAWALAN"]),
                img: val(["IMAGE", "GAMBAR", "FOTO"]), 
                caption: val(["CAPTION", "KETERANGAN", "MEDIA"]) // Text
            };

            // 2. Setup Gambar
            keptImages = [];
            if(d.img) keptImages = String(d.img).split(',').map(s=>s.trim()).filter(s=>s.startsWith('http'));

            // 3. Render HTML
            let html = `
            <div id="fullEditForm">
                <input type="hidden" id="fe_row" value="${d.row}">
                <h6 class="text-primary border-bottom pb-2">A. Lokasi & Tarikh</h6>
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small fw-bold">Negeri</label><select id="fe_negeri" class="form-select form-select-sm" onchange="updateDistricts('fe_negeri','fe_daerah')"><option value="">- Pilih -</option>${Object.keys(districtData).sort().map(n => `<option value="${n}">${n}</option>`).join('')}</select></div>
                    <div class="col-6"><label class="small fw-bold">Daerah</label><select id="fe_daerah" class="form-select form-select-sm"></select></div>
                </div>
                <div class="mb-2"><label class="small fw-bold">Lokasi/Kebun</label><input type="text" id="fe_lokasi" class="form-control form-control-sm" value="${d.lokasi}"></div>
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small fw-bold">Tarikh</label><input type="date" id="fe_tarikh" class="form-control form-control-sm" value="${d.tarikh}"></div>
                    <div class="col-6"><label class="small fw-bold">Koordinat</label><input type="text" id="fe_coord" class="form-control form-control-sm" value="${d.coord}"></div>
                </div>
                <h6 class="text-primary border-bottom pb-2 mt-3">B. Tanaman</h6>
                <div class="mb-2"><label class="small fw-bold">Kategori</label><select id="fe_kategori" class="form-select form-select-sm" onchange="updateEditDD('kat')"></select></div>
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small fw-bold">Tanaman</label><select id="fe_tanaman" class="form-select form-select-sm" onchange="updateEditDD('tan')"></select></div>
                    <div class="col-6"><label class="small fw-bold">Varieti</label><input type="text" id="fe_varieti" class="form-control form-control-sm" value="${d.varieti}"></div>
                </div>
                <div class="mb-2"><label class="small fw-bold">Luas Tanam (Ha)</label><input type="number" id="fe_luasT" class="form-control form-control-sm" value="${d.luasT}"></div>

                <h6 class="text-primary border-bottom pb-2 mt-3">C. Data Serangan</h6>
                <table class="table table-sm table-bordered" id="fe_pestTable"><thead class="table-light"><tr><th>Perosak</th><th width="70">Luas(Ha)</th><th width="70">Tahap</th><th width="30"></th></tr></thead><tbody></tbody></table>
                <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-3" onclick="addPestRow()">+ Tambah Perosak</button>

                <h6 class="text-primary border-bottom pb-2 mt-3">D. Gambar & Keterangan</h6>
                <div class="mb-2" id="existingImgContainer"></div>
                <div class="mb-3"><label class="small fw-bold">Muat Naik Gambar Baru:</label><input type="file" id="fe_newImages" class="form-control form-control-sm" multiple accept="image/*"></div>
                <div class="mb-3"><label class="small fw-bold">Keterangan Gambar</label><textarea id="fe_caption" class="form-control" rows="2">${d.caption}</textarea></div>

                <h6 class="text-primary border-bottom pb-2 mt-3">E. Syor</h6>
                <div class="mb-3"><textarea id="fe_syor" class="form-control" rows="4">${d.syor}</textarea></div>
                <button class="btn btn-success w-100 py-2 fw-bold" onclick="saveFullEdit()">SIMPAN & HANTAR</button>
            </div>`;

            document.getElementById('detailBody').innerHTML = html;
            document.getElementById('modalTitle').innerText = "KEMASKINI TUGASAN";

            // --- POPULATE LOGIC ---
            // 1. Negeri & Daerah
            const elN = document.getElementById('fe_negeri');
            const matchN = Object.keys(districtData).find(k => k.toUpperCase() === String(d.negeri).toUpperCase());
            if(matchN) { elN.value = matchN; updateDistricts('fe_negeri', 'fe_daerah'); }
            
            const elD = document.getElementById('fe_daerah');
            const matchD = Array.from(elD.options).find(o => o.value.toUpperCase() === String(d.daerah).toUpperCase());
            if(matchD) elD.value = matchD.value;

            // 2. Kategori & Tanaman (Dinamik Dropdown)
            const elKat = document.getElementById('fe_kategori');
            const cats = refPestData ? Object.keys(refPestData).sort() : [];
            cats.forEach(c => elKat.innerHTML+=`<option value="${c}">${c}</option>`);
            
            const matchKat = cats.find(c => c.toUpperCase() === String(d.kategori).toUpperCase());
            if(matchKat) { elKat.value = matchKat; updateEditDD('kat'); }
            else if(d.kategori) { elKat.innerHTML+=`<option value="${d.kategori}" selected>${d.kategori}</option>`; updateEditDD('kat'); }

            const elTan = document.getElementById('fe_tanaman');
            const matchTan = Array.from(elTan.options).find(o => o.value.toUpperCase() === String(d.tanaman).toUpperCase());
            if(matchTan) elTan.value = matchTan.value;
            else if(d.tanaman) elTan.innerHTML+=`<option value="${d.tanaman}" selected>${d.tanaman}</option>`;

            // 3. Pest Data
            let luasObj={}, sevObj={};
            try { luasObj = typeof d.luasS==='string' ? JSON.parse(d.luasS) : d.luasS; } catch(e){}
            try { sevObj = typeof d.keterukan==='string' ? JSON.parse(d.keterukan) : d.keterukan; } catch(e){}
            if(luasObj && Object.keys(luasObj).length) Object.keys(luasObj).forEach(p => addPestRow(p, luasObj[p], sevObj[p]));
            else addPestRow();

            // 4. Render Images (BUTTON LINK)
            renderKeptImages();

            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // --- HELPER UNTUK GAMBAR VIEW LINK ---
        function toViewLink(link) {
            // Tukar link download/open kepada link view/preview
            if(!link) return "";
            const idMatch = link.match(/[-\w]{25,}/);
            if(idMatch) {
                return `https://drive.google.com/file/d/${idMatch[0]}/view?usp=sharing`;
            }
            return link; 
        }

        function renderKeptImages() {
            const c = document.getElementById('existingImgContainer'); c.innerHTML = "";
            if(keptImages.length === 0) { c.innerHTML = "<small class='text-muted fst-italic'>Tiada gambar.</small>"; return; }
            keptImages.forEach((url, i) => {
                const viewUrl = toViewLink(url);
                c.innerHTML += `
                <div class="d-flex align-items-center justify-content-between border rounded p-2 mb-2 bg-white">
                    <a href="${viewUrl}" target="_blank" class="btn btn-sm btn-outline-primary fw-bold">
                        <i class="bi bi-eye me-1"></i> Lihat Gambar ${i+1}
                    </a>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeImage(${i})"><i class="bi bi-trash"></i></button>
                </div>`;
            });
        }
        function removeImage(i) { if(confirm("Padam gambar?")) { keptImages.splice(i,1); renderKeptImages(); } }

        // --- STANDARD DROPDOWN & SAVE ---
        function updateEditDD(lvl) {
            if(lvl==='kat') {
                const k = document.getElementById('fe_kategori').value;
                const t = document.getElementById('fe_tanaman'); t.innerHTML='<option value="">- Pilih -</option>';
                if(k && refPestData && refPestData[k]) Object.keys(refPestData[k]).sort().forEach(x=>t.innerHTML+=`<option value="${x}">${x}</option>`);
            }
            // Update Pest Dropdown
            const k = document.getElementById('fe_kategori').value;
            const t = document.getElementById('fe_tanaman').value;
            let pests = (k && t && refPestData && refPestData[k] && refPestData[k][t]) ? refPestData[k][t] : [];
            document.querySelectorAll('.p-name-select').forEach(s => {
                const cur = s.value; s.innerHTML='<option value="">- Pilih -</option>';
                pests.forEach(p=>s.innerHTML+=`<option value="${p}">${p}</option>`);
                if(cur && !pests.includes(cur)) s.innerHTML+=`<option value="${cur}" selected>${cur}</option>`;
                else if(cur) s.value=cur;
            });
        }

        function addPestRow(name="", area="", sev="") {
            const k = document.getElementById('fe_kategori').value;
            const t = document.getElementById('fe_tanaman').value;
            let pests = (k && t && refPestData && refPestData[k] && refPestData[k][t]) ? refPestData[k][t] : [];
            let optHTML = '<option value="">- Pilih -</option>';
            pests.forEach(p=>optHTML+=`<option value="${p}" ${p===name?'selected':''}>${p}</option>`);
            if(name && !pests.includes(name)) optHTML+=`<option value="${name}" selected>${name}</option>`;

            const tr = document.createElement('tr');
            tr.innerHTML = `<td><select class="form-select form-select-sm p-name-select" onfocus="updateEditDD()">${optHTML}</select></td>
            <td><input type="number" class="form-control form-control-sm p-area" value="${area}" step="0.01"></td>
            <td><select class="form-select form-select-sm p-sev"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></td>
            <td class="text-center"><button class="btn btn-link text-danger p-0" onclick="this.closest('tr').remove()"><i class="bi bi-x-circle"></i></button></td>`;
            if(sev) tr.querySelector('.p-sev').value = sev;
            document.querySelector('#fe_pestTable tbody').appendChild(tr);
        }

        async function saveFullEdit() {
            if(!confirm("Hantar kemaskini?")) return;
            const btn = event.target; btn.innerHTML="Menghantar..."; btn.disabled=true;
            
            // Gambar Baru
            const newImages = [];
            const fileInput = document.getElementById('fe_newImages');
            if(fileInput.files.length) {
                for(let f of fileInput.files) {
                    const b64 = await new Promise(r => { const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); });
                    newImages.push({name:f.name, dataUrl:b64});
                }
            }

            // Data Pest
            const luasS={}, sevS={}, pctS={}; const lt = parseFloat(document.getElementById('fe_luasT').value)||0;
            document.querySelectorAll('#fe_pestTable tbody tr').forEach(tr => {
                const n = tr.querySelector('.p-name-select').value;
                const a = parseFloat(tr.querySelector('.p-area').value)||0;
                const s = tr.querySelector('.p-sev').value;
                if(n) { luasS[n]=a; sevS[n]=s; pctS[n]= lt>0 ? ((a/lt)*100).toFixed(2) : 0; }
            });

            const payload = {
                row: document.getElementById('fe_row').value,
                pegawai: uProf.name,
                tarikh: document.getElementById('fe_tarikh').value,
                negeri: document.getElementById('fe_negeri').value,
                daerah: document.getElementById('fe_daerah').value,
                lokasi: document.getElementById('fe_lokasi').value,
                coord: document.getElementById('fe_coord').value,
                kategori: document.getElementById('fe_kategori').value,
                tanaman: document.getElementById('fe_tanaman').value,
                varieti: document.getElementById('fe_varieti').value,
                luasT: lt, luasS: luasS, keterukan: sevS, peratus: pctS,
                syor: document.getElementById('fe_syor').value,
                keptImages: keptImages,
                newImages: newImages,
                caption: document.getElementById('fe_caption').value
            };

            const r = await postData('updateEntry', payload);
            if(r.success) { alert("✅ Berjaya!"); bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide(); loadMyTasks(); initDash(); }
            else { alert("Ralat: "+r.message); btn.innerHTML="SIMPAN & HANTAR"; btn.disabled=false; }
        }

        // --- PENGESAHAN & DOWNLOAD (CODE ASAL) ---
        async function loadPend() {
            const c = document.getElementById('verifyContainer'); c.innerHTML='<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';
            const d = await postData('getPending', {state: uProf.state});
            if(!d.rows || !d.rows.length) { c.innerHTML='<div class="col-12 text-center p-5 text-muted border rounded">Tiada data baru.</div>'; return; }
            c.innerHTML = "";
            const hdrs = (d.headers||[]).map(h=>String(h).toUpperCase());
            d.rows.forEach(r => {
                const get = (k) => { const i = hdrs.findIndex(h => h.includes(k)); return i > -1 ? r.data[i] : ""; };
                const imgRaw = get("IMAGE") || get("GAMBAR") || "";
                const imgs = imgRaw ? String(imgRaw).split(',').map(s=>s.trim()).filter(s=>s.startsWith('http')) : [];
                let imgHTML = imgs.length ? `<div class="mt-2 pt-2 border-top small fw-bold">LAMPIRAN:</div><div class="d-flex flex-wrap gap-2 mt-1">` + imgs.map((u,i)=>`<a href="${toViewLink(u)}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-2" style="font-size:0.75rem">Gambar ${i+1}</a>`).join('') + `</div>` : "";
                
                c.innerHTML += `
                <div class="col-md-6 col-xl-4">
                    <div class="verify-card bg-white rounded-3 shadow-sm border mb-3">
                        <div class="p-3 border-bottom bg-light d-flex justify-content-between">
                            <div><div class="small text-muted">${get("TARIKH")}</div><div class="fw-bold">${get("NAMA")}</div></div>
                            <span class="badge bg-warning text-dark">BARU</span>
                        </div>
                        <div class="p-3 pb-0 small">
                            <div class="row g-1"><div class="col-4 fw-bold">Lokasi:</div><div class="col-8">${get("LOKASI")}</div></div>
                            <div class="row g-1"><div class="col-4 fw-bold">Tanaman:</div><div class="col-8">${get("TANAMAN")}</div></div>
                            <div class="row g-1"><div class="col-4 fw-bold">Serangan:</div><div class="col-8">${get("LUAS SERANGAN") || "{}"}</div></div>
                        </div>
                        <div class="px-3 pb-3">${imgHTML}</div>
                        <div class="p-3 pt-0 d-flex gap-2">
                            <button class="btn btn-outline-danger btn-sm flex-grow-1" onclick="subVer(${r.row},'REJECT')">TOLAK</button>
                            <button class="btn btn-success btn-sm flex-grow-1" onclick="subVer(${r.row},'APPROVE')">SAHKAN</button>
                        </div>
                    </div>
                </div>`;
            });
        }
        async function subVer(row, act) { let re=""; if(act==='REJECT'){re=prompt("Sebab:");if(!re)return;} else if(!confirm("Sahkan?"))return; const r=await postData('submitVerify',{row,act,reason:re,name:uProf.name}); alert(r.message); if(r.success){ loadPend(); initDash(); } }
        async function approveAll() { if(!confirm("Sahkan SEMUA?"))return; const d=await postData('getPending',{state:uProf.state}); if(d.rows) for(let r of d.rows) await postData('submitVerify',{row:r.row,act:'APPROVE',reason:'Bulk',name:uProf.name}); alert("Selesai"); loadPend(); initDash(); }

        // --- ORIGINAL VIEW REC (RETAINED) ---
        function viewRec(d) {
            // (Design Asal)
            const cleanImg = (raw) => { if (!raw) return []; let str = String(raw).trim().replace(/[\[\]"'\\]/g, ''); return str.split(',').map(l => l.trim()).filter(l => l.toLowerCase().startsWith('http')); };
            let pestRows = "";
            if (d.p && Object.keys(d.p).length > 0) { Object.keys(d.p).forEach(k => { let luasVal = d.p[k], pctVal = (d.pp && d.pp[k]) ? d.pp[k] : 0, sevVal = (d.pk && d.pk[k]) ? d.pk[k] : 0, level = parseInt(sevVal) || 0; let badgeColor = level < 3 ? 'success' : (level < 4 ? 'warning' : 'danger'); pestRows += `<tr><td style="font-size:0.85rem" class="text-uppercase">${k}</td><td class="text-center fw-bold">${parseFloat(luasVal).toFixed(2)}</td><td class="text-center small">${pctVal}%</td><td class="text-center"><span class="badge bg-${badgeColor}">T${level}</span></td></tr>`; }); } else { pestRows = `<tr><td colspan="4" class="text-center text-muted small">Tiada Data Terperinci</td></tr>`; }
            const imgLinks = cleanImg(d.im);
            let imgHTML = imgLinks.length > 0 ? `<div class="mt-3 pt-2 border-top"><h6 class="fw-bold text-secondary small mb-2 text-uppercase"><i class="bi bi-paperclip me-1"></i> LAMPIRAN GAMBAR</h6><div class="d-flex flex-wrap gap-2">` + imgLinks.map((lnk,i)=>`<a href="${lnk}" target="_blank" class="btn btn-sm btn-outline-primary bg-white shadow-sm text-truncate fw-bold" style="max-width:140px;"><i class="bi bi-image me-1"></i> Gambar ${i+1}</a>`).join('') + `</div></div>` : `<div class="mt-3 pt-2 border-top"><small class="text-muted fst-italic text-uppercase"><i class="bi bi-slash-circle me-1"></i> TIADA GAMBAR</small></div>`;
            
            let adminBtns = "";
            if (uProf.role === "ADMIN") { adminBtns = `<div class="border-top pt-3 mt-3 d-flex justify-content-between gap-2"><button onclick="enableEditMode(${d.id})" class="btn btn-outline-primary btn-sm flex-grow-1"><i class="bi bi-pencil-square me-1"></i> KEMASKINI</button><button onclick="doDeleteRec(${d.id})" class="btn btn-outline-danger btn-sm flex-grow-1"><i class="bi bi-trash-fill me-1"></i> PADAM</button></div>`; }

            const html = `
            <div class="verify-card bg-white rounded-3 shadow-sm border h-100 position-relative">
                <div class="p-3 border-bottom bg-light d-flex justify-content-between align-items-start">
                    <div><div class="small text-muted mb-1"><i class="bi bi-calendar3 me-1"></i> ${d.t}</div><div class="fw-bold text-uppercase text-dark">${d.pg}</div><div class="small text-muted fst-italic">${d.em}</div></div><span class="badge bg-success text-white shadow-sm">DISAHKAN</span>
                </div>
                <div class="p-3 pb-0">
                    <h6 class="fw-bold text-success mb-3 small border-bottom pb-2 text-uppercase"><i class="bi bi-info-circle-fill me-1"></i> LOKASI & TANAMAN</h6>
                    <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">NEGERI:</div><div class="col-8 fw-bold text-dark">${d.n}</div></div>
                    <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">DAERAH:</div><div class="col-8 fw-bold text-dark">${d.d}</div></div>
                    <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">LOKASI:</div><div class="col-8 fw-bold text-dark">${d.l}</div></div>
                    <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">KOORDINAT:</div><div class="col-8 font-monospace text-muted small">${d.c}</div></div>
                    <hr class="my-2 text-muted opacity-25">
                    <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">KATEGORI:</div><div class="col-8 fw-bold text-dark text-uppercase">${d.kt || "-"}</div></div>
                    <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">TANAMAN:</div><div class="col-8 fw-bold text-success">${d.tn}</div></div>
                    <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">VARIETI:</div><div class="col-8 text-uppercase">${d.vr}</div></div>
                    <div class="row g-2 mb-3" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">LUAS TANAMAN:</div><div class="col-8 text-dark">${d.lt.toFixed(2)} HA</div></div>
                </div>
                <div class="px-3">
                    <h6 class="fw-bold text-success mb-2 small text-uppercase"><i class="bi bi-bug-fill me-1"></i> DATA SERANGAN</h6>
                    <div class="table-responsive border rounded mb-2"><table class="table table-sm table-striped mb-0" style="font-size:0.8rem"><thead class="table-light"><tr><th>PEROSAK</th><th class="text-center">LUAS (HA)</th><th class="text-center">%</th><th class="text-center">TAHAP</th></tr></thead><tbody>${pestRows}</tbody></table></div>
                    <div class="alert alert-warning border-warning mb-0 py-2 px-3 small"><i class="bi bi-lightbulb-fill text-warning me-1"></i> <strong>SYOR:</strong> ${d.s}</div>${imgHTML}
                </div>
                <div class="p-3 mt-auto"><div class="bg-success bg-opacity-10 border border-success rounded p-2 text-center"><small class="text-success fw-bold text-uppercase mb-1 d-block">DISAHKAN OLEH:</small><div class="text-dark small fw-bold">${d.vb}</div></div>${adminBtns}</div>
            </div>`;
            document.getElementById('detailBody').innerHTML = html;
            document.getElementById('modalTitle').innerText = "BUTIRAN REKOD DISAHKAN";
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        async function doDeleteRec(rowID) { if(!confirm("Padam rekod ini?")) return; const btn = event.target.closest('button'); btn.innerHTML='...'; btn.disabled=true; const r = await postData('deleteEntry', {row:rowID}); alert(r.message); if(r.success) location.reload(); }
        async function downloadDualExcel() { if(!fData.length){alert("Tiada data");return;} const wb=new ExcelJS.Workbook(); const ws=wb.addWorksheet('Laporan'); ws.columns=[{header:'Tarikh',key:'t'},{header:'Negeri',key:'n'},{header:'Lokasi',key:'l'},{header:'Tanaman',key:'tn'},{header:'Luas(S)',key:'ls'}]; fData.forEach(r=>ws.addRow(r)); const b=await wb.xlsx.writeBuffer(); const a=document.createElement('a'); a.href=window.URL.createObjectURL(new Blob([b])); a.download='Laporan.xlsx'; a.click(); }
        async function dlPDF() { alert("Fungsi PDF akan datang."); }

        function formatDateForInput(d) { if(!d)return""; const dt=new Date(d); return isNaN(dt)?"":dt.toISOString().split('T')[0]; }
        function formatSyorPerenggan(t) { return t; } 
        function updateDistricts(s,t) { const v=document.getElementById(s).value; const el=document.getElementById(t); el.innerHTML='<option value="">- Pilih -</option>'; if(v&&districtData[v]) districtData[v].forEach(x=>el.innerHTML+=`<option value="${x}">${x}</option>`); }
    </script>
</body>
</html>
