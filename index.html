<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem PNR Digital - UPGRADE MODE</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

    <style>
        :root { --primary: #064e3b; --accent: #10b981; --bg: #f3f4f6; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; margin:0; }
        
        /* LOGIN & LAYOUT */
        #loginOverlay { position: fixed; inset: 0; z-index: 999999; display: flex; align-items: center; justify-content: center; background: #064e3b; }
        .login-box { background: white; padding: 2.5rem; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .sidebar { width: 260px; height: 100vh; position: fixed; top: 0; left: 0; background: #e8f5e9; border-right: 1px solid #c6e7ce; padding: 20px; z-index: 100; transition: transform 0.3s; display: flex; flex-direction: column; }
        .brand { font-size: 1.3rem; font-weight: 900; color: #000; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; padding-left: 10px; flex-shrink: 0; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding-right: 5px; margin-bottom: 10px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: #000; font-weight: 600; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .nav-item:hover { background: #c8e6c9; color: #000; }
        .nav-item.active { background: #1b5e20; color: white; font-weight: 700; }
        .sidebar-footer { flex-shrink: 0; border-top: 1px solid #c6e7ce; padding-top: 15px; }
        .main-content { margin-left: 260px; padding: 25px; transition: margin-left 0.3s; }
        
        /* DASHBOARD CARDS */
        .kpi-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid #e5e7eb; height: 100%; transition: transform 0.2s; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: #111827; margin-top: 5px; }
        .map-box { height: 400px; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb; position: relative; z-index: 1; }
        .table-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; overflow: hidden; }
        .text-danger { color: #dc2626 !important; }
        .badge-pending { background: #dc2626; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; display: none; }

        .verify-card { background: #fff; border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; height: 100%; display: flex; flex-direction: column; transition: transform 0.2s; border: 1px solid #e2e8f0; }
        .verify-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .task-reject-box { background-color: #fef2f2; border: 1px solid #fecaca; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #b91c1c; }
        
        .img-thumb-container { position: relative; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
        .img-thumb-container img { width: 100%; height: 100%; object-fit: cover; }
        .btn-del-img { position: absolute; top: 2px; right: 2px; background: rgba(220, 38, 38, 0.9); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <div class="brand justify-content-center mb-4"><i class="bi bi-flower1"></i> PNR DIGITAL v2.0</div>
            <h6 class="text-muted mb-4">Log Masuk Sistem</h6>
            <input type="text" id="uid" class="form-control mb-3 p-3" placeholder="ID Pengguna">
            <input type="password" id="pwd" class="form-control mb-4 p-3" placeholder="Kata Laluan">
            <button type="button" onclick="doLogin()" class="btn btn-success w-100 fw-bold p-3" id="btnLogin">MASUK</button>
            <small id="loginMsg" class="text-danger d-block mt-3 fw-bold"></small>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="brand"><i class="bi bi-flower1"></i> PNR DIGITAL</div>
        
        <div class="sidebar-content">
            <div class="nav-item active" onclick="switchTab('main', this)">
                <span><i class="bi bi-grid-1x2-fill me-2"></i> Dashboard</span>
            </div>
            
            <div class="nav-item" id="navTasks" style="display:none" onclick="switchTab('tasks', this)">
                <span><i class="bi bi-list-task me-2"></i> Tugasan Saya</span>
                <span class="badge-pending" id="badgeTask" style="background:#dc2626;">0</span>
            </div>

            <div class="nav-item" id="navVerify" style="display:none" onclick="switchTab('verify', this)">
                <span><i class="bi bi-check-circle-fill me-2"></i> Pengesahan</span>
                <span class="badge-pending" id="badgePending">0</span>
            </div>
            <hr class="my-4" style="color: #000;">
            
            <div class="mb-3 px-2">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <small class="fw-bold text-dark"><i class="bi bi-funnel-fill me-1"></i> TAPISAN DATA</small>
                </div>
                
                <div class="mb-2"><label class="small fw-bold">Negeri</label><select id="selNegeri" class="form-select form-select-sm" onchange="runFilter('n')"></select></div>
                <div class="mb-2"><label class="small fw-bold">Daerah</label><select id="selDaerah" class="form-select form-select-sm" onchange="runFilter('d')"></select></div>
                <div class="mb-2"><label class="small fw-bold">Tanaman</label><select id="selTanaman" class="form-select form-select-sm" onchange="runFilter('t')"></select></div>
                <div class="mb-2"><label class="small fw-bold">Perosak</label><select id="selPerosak" class="form-select form-select-sm" onchange="runFilter('p')"></select></div>
                
                <div class="mb-3">
                    <label class="small fw-bold">Julat Tarikh</label>
                    <div class="row g-1">
                        <div class="col-6"><input type="date" id="dS" class="form-control form-control-sm" onchange="runFilter()"></div>
                        <div class="col-6"><input type="date" id="dE" class="form-control form-control-sm" onchange="runFilter()"></div>
                    </div>
                </div>
                
                <button class="btn btn-dark btn-sm w-100" onclick="resetFilter()"><i class="bi bi-arrow-counterclockwise"></i> Reset Tapisan</button>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div class="nav-item mb-3 bg-success text-white shadow-sm" onclick="switchTab('form', this)">
                <span><i class="bi bi-plus-lg me-2"></i> Tambah Data</span>
            </div>
            <div class="d-flex align-items-center justify-content-between px-2">
                <div><small class="text-dark d-block fw-bold">Pengguna</small><strong id="uDisp" class="text-dark small">-</strong></div>
                <button class="btn btn-link text-danger btn-sm p-0" onclick="doLogout()"><i class="bi bi-box-arrow-right fs-5"></i></button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="d-md-none mb-3 d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm">
            <span class="fw-bold text-success fs-5"><i class="bi bi-flower1"></i> PNR</span>
            <button class="btn btn-light btn-sm border" onclick="document.getElementById('sidebar').classList.toggle('active')"><i class="bi bi-list fs-5"></i></button>
        </div>

        <div id="view-main">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                <div><h4 class="fw-bold m-0 text-dark">Analisis Data</h4><small class="text-muted">Paparan data terkini</small></div>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-white border bg-white text-secondary btn-sm px-3" onclick="initDash()"><i class="bi bi-arrow-clockwise"></i></button>
                    <button class="btn btn-success btn-sm px-3" onclick="downloadDualExcel()"><i class="bi bi-file-earmark-excel me-1"></i> Excel</button>
                    <button class="btn btn-danger btn-sm px-3" onclick="dlPDF()"><i class="bi bi-file-earmark-pdf me-1"></i> Laporan Penuh</button>
                </div>
            </div>
            
            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="small fw-bold">Luas Bancian</span><i class="bi bi-rulers text-success"></i></div><div class="kpi-value" id="k1">0</div><small class="text-muted fw-bold">Hektar</small></div></div>
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="small fw-bold">Luas Serangan</span><i class="bi bi-bug-fill text-danger"></i></div><div class="kpi-value text-danger" id="k2">0</div><small class="text-muted fw-bold">Hektar</small></div></div>
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="small fw-bold">Peratus</span><i class="bi bi-percent text-warning"></i></div><div class="kpi-value" id="k3">0%</div><small class="text-muted fw-bold">Kadar</small></div></div>
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="small fw-bold">Rekod</span><i class="bi bi-file-text text-primary"></i></div><div class="kpi-value" id="k4">0</div><small class="text-muted fw-bold">Unit</small></div></div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-8"><div class="map-box shadow-sm" id="map"></div></div>
                <div class="col-md-4">
                    <div class="table-box h-100 shadow-sm" style="max-height:400px; overflow-y:auto">
                        <h6 class="fw-bold mb-3 text-danger"><i class="bi bi-fire me-2"></i>Hotspot Daerah</h6>
                        <table class="table table-hover small mb-0"><thead class="table-light sticky-top"><tr><th>Daerah</th><th class="text-end">Luas(Ha)</th></tr></thead><tbody id="hotspotTable"></tbody></table>
                    </div>
                </div>
            </div>

            <div class="table-box shadow-sm">
                <div class="d-flex justify-content-between mb-3"><h6 class="fw-bold"><i class="bi bi-table me-2"></i>Jadual Rekod</h6><small id="pgInfo" class="text-muted"></small></div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light"><tr><th>Tarikh</th><th>Lokasi</th><th>Tanaman</th><th>Luas(S)</th><th>Tindakan</th></tr></thead>
                        <tbody id="tBody"></tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-2">
                    <button class="btn btn-sm btn-white border shadow-sm px-3" onclick="movePg(-1)">Prev</button>
                    <button class="btn btn-sm btn-white border shadow-sm px-3" onclick="movePg(1)">Next</button>
                </div>
            </div>
        </div>

        <div id="view-tasks" style="display:none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold m-0 text-dark">Tugasan Saya</h4>
                <button class="btn btn-primary btn-sm px-3" onclick="loadMyTasks()"><i class="bi bi-arrow-clockwise me-1"></i> Refresh</button>
            </div>
            <div id="taskContainer" class="row g-3"></div>
        </div>

        <div id="view-verify" style="display:none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold m-0 text-dark">Pengesahan Data</h4>
                <button class="btn btn-success btn-sm px-3 fw-bold" onclick="approveAll()">Sahkan Semua</button>
            </div>
            <div id="verifyContainer" class="row g-3"></div>
        </div>

        <div id="view-form" style="display:none; height: 100%;">
            <iframe id="frameBorang" src="" style="width: 100%; height: 85vh; border: none; border-radius: 12px;"></iframe>
        </div>

    </div>

    <div class="modal fade" id="detailModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success text-white">
                    <h6 class="modal-title fw-bold" id="modalTitle">BUTIRAN</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light p-4" id="detailBody"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // *** GANTI URL DI BAWAH ***
        const API_URL = "https://script.google.com/macros/s/AKfycbx1hlsIWN5MCo7ab_ytT_d_oFqVjy1XMJwM39oBC8yPp9OLukRSbk47Ufate26quu4k/exec";
        const BANCIAN_URL = "https://script.google.com/macros/s/AKfycbz2hKf0rlCm8xWD_kXwEi0kYiVCOtcX1_noM6S0dHjkDJOrG6LtQ3GGt-4TT0plWVm60g/exec";
        document.getElementById('frameBorang').src = BANCIAN_URL;

        // DATA UTAMA
        const districtData = {
            "Johor": ["Batu Pahat", "Johor Bahru", "Kluang", "Kota Tinggi", "Kulai", "Mersing", "Muar", "Pontian", "Segamat", "Tangkak"],
            "Kedah": ["Baling", "Bandar Baharu", "Kota Setar", "Kuala Muda", "Kubang Pasu", "Kulim", "Langkawi", "Padang Terap", "Pendang", "Pokok Sena", "Sik", "Yan"],
            "Kelantan": ["Bachok", "Gua Musang", "Jeli", "Kota Bharu", "Kuala Krai", "Machang", "Pasir Mas", "Pasir Puteh", "Tanah Merah", "Tumpat"],
            "Melaka": ["Alor Gajah", "Jasin", "Melaka Tengah"],
            "Negeri Sembilan": ["Jelebu", "Jempol", "Kuala Pilah", "Port Dickson", "Rembau", "Seremban", "Tampin"],
            "Pahang": ["Bentong", "Bera", "Cameron Highlands", "Jerantut", "Kuantan", "Lipis", "Maran", "Pekan", "Raub", "Rompin", "Temerloh"],
            "Perak": ["Bagan Datuk", "Batang Padang", "Hilir Perak", "Hulu Perak", "Kampar", "Kerian", "Kinta", "Kuala Kangsar", "Larut, Matang dan Selama", "Manjung", "Muallim", "Perak Tengah"],
            "Perlis": ["Perlis"],
            "Pulau Pinang": ["Barat Daya", "Seberang Perai Selatan", "Seberang Perai Tengah", "Seberang Perai Utara", "Timur Laut"],
            "Sabah": ["Beaufort", "Beluran", "Kalabakan", "Keningau", "Kinabatangan", "Kota Belud", "Kota Kinabalu", "Kota Marudu", "Kuala Penyu", "Kudat", "Kunak", "Lahad Datu", "Nabawan", "Papar", "Penampang", "Pitas", "Putatan", "Ranau", "Sandakan", "Semporna", "Sipitang", "Tambunan", "Tawau", "Telupid", "Tenom", "Tongod", "Tuaran"],
            "Sarawak": ["Asajaya", "Bau", "Belaga", "Beluru", "Betong", "Bintulu", "Bukit Mabong", "Dalat", "Daro", "Julau", "Kabong", "Kanowit", "Kapit", "Kuching", "Lawas", "Limbang", "Lubok Antu", "Lundu", "Marudi", "Matu", "Meradong", "Miri", "Mukah", "Pakan", "Pusa", "Samarahan", "Saratok", "Sarikei", "Sebauh", "Selangau", "Serian", "Sibu", "Simunjan", "Song", "Sri Aman", "Subis", "Tanjung Manis", "Tatau", "Tebedu", "Telang Usan"],
            "Selangor": ["Gombak", "Hulu Langat", "Hulu Selangor", "Klang", "Kuala Langat", "Kuala Selangor", "Petaling", "Sabak Bernam", "Sepang"],
            "Terengganu": ["Besut", "Dungun", "Hulu Terengganu", "Kemaman", "Kuala Nerus", "Kuala Terengganu", "Marang", "Setiu"],
            "W.P. Kuala Lumpur": ["Kuala Lumpur"], "W.P. Labuan": ["Labuan"], "W.P. Putrajaya": ["Putrajaya"]
        };

        let mData=[], fData=[], uProf=null, map=null, layer=null, pg=1, pSize=10;
        let refPestData = null; // [REQ 2] Variable untuk simpan data reference
        let keptImages = []; // [REQ 3] Variable untuk simpan gambar lama yg dikekalkan

        // --- FETCHING ---
        async function postData(act, load) {
            try {
                let payload = { action: act, ...load };
                const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                return await res.json();
            } catch(e) { console.error(e); return {success:false, message:"Ralat sambungan."}; }
        }

        // [REQ 2] FUNGSI TARIK REFERENCE DATA (LIVE)
        async function loadRefData() {
            if(refPestData) return; // Dah ada, tak payah tarik lagi
            console.log("Menarik data Pest_List...");
            // Kita guna teknik doGet parameter action=getPestData
            try {
                const res = await fetch(API_URL + "?action=getPestData");
                refPestData = await res.json();
                console.log("Reference Loaded:", refPestData);
            } catch(e) { console.error("Gagal tarik reference:", e); }
        }

        // --- AUTH & INIT ---
        async function doLogin() {
            const u = document.getElementById('uid').value, p = document.getElementById('pwd').value;
            const btn = document.getElementById('btnLogin');
            if(!u || !p) return;
            btn.innerText="Memproses..."; btn.disabled=true;
            const r = await postData('login', {u, p});
            if(r.success) {
                uProf = r;
                document.getElementById('uDisp').innerText = r.name;
                document.getElementById('loginOverlay').style.display = 'none';
                if(["ADMIN","PENYELIA"].includes(r.role)) document.getElementById('navVerify').style.display="flex";
                document.getElementById('navTasks').style.display="flex";
                loadMyTasks(); // Cek task
                initDash();
                loadRefData(); // [REQ 2] Tarik data dropdown siap-siap
            } else {
                document.getElementById('loginMsg').innerText = r.message;
                btn.innerText="MASUK"; btn.disabled=false;
            }
        }

        async function initDash() {
            const d = await postData('getAnalytics', {state: uProf.state});
            if(d.records) {
                mData = d.records;
                // Populate Filter Dropdowns
                const populate = (id, fn) => {
                    const el = document.getElementById(id); el.innerHTML='<option value="">Semua</option>';
                    [...new Set(mData.map(fn).filter(x=>x))].sort().forEach(x=>el.innerHTML+=`<option value="${x}">${x}</option>`);
                };
                populate('selNegeri', r=>r.n);
                if(uProf.state!=="ALL") { document.getElementById('selNegeri').value=uProf.state; document.getElementById('selNegeri').disabled=true; }
                runFilter();
            }
        }

        function runFilter(src) {
            const n=v('selNegeri'), d=v('selDaerah'), t=v('selTanaman');
            fData = mData.filter(r => (n===""||r.n===n) && (d===""||r.d===d) && (t===""||r.tn===t));
            
            // Cascading Filters
            if(src==='n') updateDD('selDaerah', fData.map(r=>r.d));
            if(src==='d'||src==='n') updateDD('selTanaman', fData.map(r=>r.tn));
            
            calcUI();
        }
        function updateDD(id, arr) {
            const el=document.getElementById(id), old=el.value; el.innerHTML='<option value="">Semua</option>';
            [...new Set(arr.filter(x=>x))].sort().forEach(x=>el.innerHTML+=`<option value="${x}">${x}</option>`);
            el.value = old;
        }
        function v(id){ return document.getElementById(id).value; }

        function calcUI() {
            let tt=0, ts=0; fData.forEach(r => { tt+=r.lt; ts+=r.ls; });
            document.getElementById('k1').innerText = tt.toFixed(2);
            document.getElementById('k2').innerText = ts.toFixed(2);
            document.getElementById('k3').innerText = tt>0 ? ((ts/tt)*100).toFixed(1)+"%" : "0%";
            document.getElementById('k4').innerText = fData.length;
            
            // Map
            if(!map) { map = L.map('map').setView([4.2, 101.9], 6); L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map); }
            if(layer) map.removeLayer(layer);
            let pts=[]; fData.forEach(r=>{ if(r.c && r.c.includes(',')) pts.push(r.c.split(',').map(Number)); });
            if(pts.length) layer=L.layerGroup(pts.map(p=>L.circleMarker(p,{radius:5,color:'red',fillOpacity:0.8}))).addTo(map);

            // Hotspot
            let h={}; fData.forEach(r=>{ if(r.ls>0) h[r.d]=(h[r.d]||0)+r.ls; });
            document.getElementById('hotspotTable').innerHTML = Object.entries(h).sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>`<tr><td>${x[0]}</td><td class="text-end text-danger fw-bold">${x[1].toFixed(2)}</td></tr>`).join('');
            
            pg=1; renTab();
        }

        // [REQ 4] ADD PDF BUTTON PER ROW
        function renTab() {
            const st = (pg-1)*pSize, dt = fData.slice(st, st+pSize);
            document.getElementById('tBody').innerHTML = dt.map((d,i) => `
                <tr>
                    <td>${d.t}</td><td>${d.n}<br><small class="text-muted">${d.d}</small></td>
                    <td>${d.tn}</td><td class="text-danger fw-bold">${d.ls.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewRec(${st+i})"><i class="bi bi-eye"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="dlRowPDF(${st+i})" title="PDF Laporan"><i class="bi bi-file-pdf"></i></button>
                    </td>
                </tr>`).join('');
            document.getElementById('pgInfo').innerText = `Page ${pg}`;
        }
        function movePg(v){ pg=Math.max(1, pg+v); renTab(); }

        // --- EDIT MODE UTILITIES ---

        // [REQ 2] RENDER EDIT FORM (DYNAMIC DROPDOWNS)
        async function renderEditForm(rowID, rowData) {
            // Pastikan ref data dah ada
            if(!refPestData) await loadRefData();

            const d = rowData;
            
            // Parse Gambar Sedia Ada
            keptImages = []; // Reset global tracking
            const rawImg = d[18] || ""; // Col 19 (Index 18)
            if(rawImg) {
                keptImages = rawImg.split(',').map(s=>s.trim()).filter(s=>s.startsWith('http'));
            }

            // Generate HTML
            let html = `
            <div id="fullEditForm">
                <input type="hidden" id="fe_row" value="${rowID}">
                
                <h6 class="text-primary border-bottom pb-2">A. Lokasi & Tarikh</h6>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="small fw-bold">Negeri</label>
                        <select id="fe_negeri" class="form-select form-select-sm" onchange="updateDistricts('fe_negeri','fe_daerah')">
                            <option value="">- Pilih -</option>
                            ${Object.keys(districtData).sort().map(n => `<option value="${n}">${n}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-6"><label class="small fw-bold">Daerah</label><select id="fe_daerah" class="form-select form-select-sm"></select></div>
                </div>
                <div class="mb-2"><label class="small fw-bold">Lokasi/Kebun</label><input type="text" id="fe_lokasi" class="form-control form-control-sm"></div>
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small fw-bold">Tarikh</label><input type="date" id="fe_tarikh" class="form-control form-control-sm"></div>
                    <div class="col-6"><label class="small fw-bold">Koordinat</label><input type="text" id="fe_coord" class="form-control form-control-sm"></div>
                </div>

                <h6 class="text-primary border-bottom pb-2 mt-3">B. Tanaman (Auto-Populate)</h6>
                <div class="mb-2">
                    <label class="small fw-bold">Kategori</label>
                    <select id="fe_kategori" class="form-select form-select-sm" onchange="updateEditDD('kat')"></select>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="small fw-bold">Tanaman</label>
                        <select id="fe_tanaman" class="form-select form-select-sm" onchange="updateEditDD('tan')"></select>
                    </div>
                    <div class="col-6"><label class="small fw-bold">Varieti</label><input type="text" id="fe_varieti" class="form-control form-control-sm"></div>
                </div>
                <div class="mb-2"><label class="small fw-bold">Luas Tanam (Ha)</label><input type="number" id="fe_luasT" class="form-control form-control-sm"></div>

                <h6 class="text-primary border-bottom pb-2 mt-3">C. Data Serangan</h6>
                <table class="table table-sm table-bordered" id="fe_pestTable">
                    <thead class="table-light"><tr><th>Perosak</th><th width="70">Luas(Ha)</th><th width="70">Tahap</th><th width="30"></th></tr></thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-3" onclick="addPestRow()">+ Tambah Perosak</button>

                <h6 class="text-primary border-bottom pb-2 mt-3">D. Gambar</h6>
                <div class="mb-2">
                    <label class="small fw-bold mb-2">Gambar Sedia Ada:</label>
                    <div id="existingImgContainer" class="d-flex flex-wrap gap-2"></div>
                </div>
                <div class="mb-3">
                    <label class="small fw-bold">Muat Naik Gambar Baru:</label>
                    <input type="file" id="fe_newImages" class="form-control form-control-sm" multiple accept="image/*">
                </div>

                <h6 class="text-primary border-bottom pb-2 mt-3">E. Syor</h6>
                <div class="mb-3">
                    <textarea id="fe_syor" class="form-control" rows="4"></textarea>
                </div>

                <button class="btn btn-success w-100 py-2 fw-bold" onclick="saveFullEdit()">SIMPAN & HANTAR</button>
            </div>`;

            document.getElementById('detailBody').innerHTML = html;
            document.getElementById('modalTitle').innerText = "KEMASKINI TUGASAN";

            // --- POPULATE VALUE ---
            const setV = (id, v) => { if(document.getElementById(id)) document.getElementById(id).value = v||""; };
            
            // 1. Lokasi
            setV('fe_tarikh', d[3] ? new Date(d[3]).toISOString().split('T')[0] : "");
            setV('fe_lokasi', d[6]);
            setV('fe_coord', d[7]);
            
            // Helper Smart Set (Cari value walaupun case beza)
            const smartSet = (elId, val, options) => {
                const el = document.getElementById(elId);
                el.innerHTML = '<option value="">- Pilih -</option>';
                options.forEach(o => { el.innerHTML += `<option value="${o}">${o}</option>`; });
                
                const match = options.find(o => String(o).toUpperCase() === String(val).toUpperCase());
                if(match) el.value = match;
                else if(val) { 
                    // [REQ 2] Jika value tiada dalam list (custom/lama), tambah option
                    el.innerHTML += `<option value="${val}" selected>${val} (Rekod Asal)</option>`;
                }
            };

            // Negeri & Daerah
            smartSet('fe_negeri', d[4], Object.keys(districtData));
            updateDistricts('fe_negeri','fe_daerah'); // Populate daerah kosong
            const elD = document.getElementById('fe_daerah'); // Set daerah
            // Isi manual option daerah sbb function atas reset
            if(d[4] && districtData[d[4]]) {
                elD.innerHTML='<option value="">- Pilih -</option>';
                districtData[d[4]].forEach(x=>elD.innerHTML+=`<option value="${x}">${x}</option>`);
            }
            elD.value = d[5];

            // 2. Kategori -> Tanaman (Cascading dari refPestData)
            const cats = refPestData ? Object.keys(refPestData).sort() : [];
            smartSet('fe_kategori', d[8], cats);
            updateEditDD('kat'); // Trigger populate tanaman
            
            // Set Tanaman
            const currentCat = document.getElementById('fe_kategori').value;
            let crops = [];
            if(currentCat && refPestData && refPestData[currentCat]) {
                crops = Object.keys(refPestData[currentCat]).sort();
            }
            smartSet('fe_tanaman', d[9], crops);
            
            setV('fe_varieti', d[11]);
            setV('fe_luasT', d[12]);

            // 3. Perosak
            let luasObj={}, sevObj={};
            try { luasObj = JSON.parse(d[14]); } catch(e){}
            try { sevObj = JSON.parse(d[16]); } catch(e){}
            const pList = Object.keys(luasObj);
            if(pList.length===0 && d[13]) addPestRow(d[13], d[14], d[16]);
            else pList.forEach(p => addPestRow(p, luasObj[p], sevObj[p]));
            if(pList.length===0) addPestRow();

            // 4. Gambar (Render Thumbnails)
            renderKeptImages();

            // 5. Syor
            setV('fe_syor', d[17]);

            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // Logic Dropdown Kategori/Tanaman dalam Edit
        function updateEditDD(level) {
            const katEl = document.getElementById('fe_kategori');
            const tanEl = document.getElementById('fe_tanaman');
            
            if(level === 'kat') {
                const k = katEl.value;
                tanEl.innerHTML = '<option value="">- Pilih -</option>';
                if(k && refPestData && refPestData[k]) {
                    Object.keys(refPestData[k]).sort().forEach(t => {
                        tanEl.innerHTML += `<option value="${t}">${t}</option>`;
                    });
                }
            }
            // Trigger update pest list dropdowns
            updatePestDropdowns();
        }

        function updatePestDropdowns() {
            const k = document.getElementById('fe_kategori').value;
            const t = document.getElementById('fe_tanaman').value;
            let pests = [];
            if(k && t && refPestData && refPestData[k] && refPestData[k][t]) {
                pests = refPestData[k][t];
            }

            document.querySelectorAll('.p-name-select').forEach(sel => {
                const cur = sel.value;
                sel.innerHTML = '<option value="">- Pilih -</option>';
                pests.forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
                // Maintain value
                const match = pests.find(p=>p===cur);
                if(match) sel.value = match;
                else if(cur) sel.innerHTML += `<option value="${cur}" selected>${cur} (Asal)</option>`;
            });
        }

        function addPestRow(name="", area="", sev="") {
            const tbody = document.querySelector('#fe_pestTable tbody');
            const tr = document.createElement('tr');
            
            // Generate list pest semasa
            const k = document.getElementById('fe_kategori') ? document.getElementById('fe_kategori').value : "";
            const t = document.getElementById('fe_tanaman') ? document.getElementById('fe_tanaman').value : "";
            let pests = [];
            if(k && t && refPestData && refPestData[k] && refPestData[k][t]) pests = refPestData[k][t];

            let opts = '<option value="">- Pilih -</option>';
            pests.forEach(p => opts += `<option value="${p}" ${p===name?'selected':''}>${p}</option>`);
            if(name && !pests.includes(name)) opts += `<option value="${name}" selected>${name} (Asal)</option>`;

            tr.innerHTML = `
                <td><select class="form-select form-select-sm p-name p-name-select" onfocus="updatePestDropdowns()">${opts}</select></td>
                <td><input type="number" class="form-control form-control-sm p-area" value="${area}" step="0.01"></td>
                <td><select class="form-select form-select-sm p-sev"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></td>
                <td class="text-center"><button class="btn btn-link text-danger p-0" onclick="this.closest('tr').remove()"><i class="bi bi-x-circle"></i></button></td>
            `;
            if(sev) tr.querySelector('.p-sev').value = sev;
            tbody.appendChild(tr);
        }

        function renderKeptImages() {
            const c = document.getElementById('existingImgContainer');
            if(!c) return;
            c.innerHTML = "";
            keptImages.forEach((url, idx) => {
                c.innerHTML += `
                <div class="img-thumb-container">
                    <img src="${url}">
                    <button class="btn-del-img" onclick="removeImage(${idx})"><i class="bi bi-x"></i></button>
                </div>`;
            });
            if(keptImages.length === 0) c.innerHTML = "<small class='text-muted fst-italic'>Tiada gambar.</small>";
        }

        function removeImage(idx) {
            keptImages.splice(idx, 1);
            renderKeptImages();
        }

        // [REQ 1 & 3] SAVE FULL EDIT
        async function saveFullEdit() {
            if(!confirm("Hantar kemaskini?")) return;
            const btn = event.target; btn.innerHTML="Menghantar..."; btn.disabled=true;

            // 1. Proses Gambar Baru (Convert to Base64)
            const fileInput = document.getElementById('fe_newImages');
            const newImages = [];
            if(fileInput.files.length > 0) {
                for (let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    const base64 = await new Promise((resolve) => {
                        const r = new FileReader();
                        r.onload = () => resolve(r.result);
                        r.readAsDataURL(file);
                    });
                    newImages.push({ name: file.name, dataUrl: base64 });
                }
            }

            // 2. Kumpul Data Perosak
            const luasS={}, sevS={}, pctS={};
            const lt = parseFloat(document.getElementById('fe_luasT').value)||0;
            document.querySelectorAll('#fe_pestTable tbody tr').forEach(tr => {
                const n = tr.querySelector('.p-name-select').value;
                const a = parseFloat(tr.querySelector('.p-area').value)||0;
                const s = tr.querySelector('.p-sev').value;
                if(n) {
                    luasS[n]=a; sevS[n]=s;
                    pctS[n]= lt>0 ? ((a/lt)*100).toFixed(2) : 0;
                }
            });

            // 3. Payload
            const payload = {
                row: document.getElementById('fe_row').value,
                tarikh: document.getElementById('fe_tarikh').value,
                pegawai: document.getElementById('fe_pegawai').value,
                negeri: document.getElementById('fe_negeri').value,
                daerah: document.getElementById('fe_daerah').value,
                lokasi: document.getElementById('fe_lokasi').value,
                coord: document.getElementById('fe_coord').value,
                kategori: document.getElementById('fe_kategori').value,
                tanaman: document.getElementById('fe_tanaman').value,
                varieti: document.getElementById('fe_varieti').value,
                luasT: lt,
                luasS: luasS, keterukan: sevS, peratus: pctS,
                
                // [REQ 1] Format Syor
                syor: formatSyorPerenggan(document.getElementById('fe_syor').value),
                
                // [REQ 3] Gambar
                keptImages: keptImages, // Array link lama
                newImages: newImages    // Array base64 baru
            };

            const r = await postData('updateEntry', payload);
            if(r.success) {
                alert("âœ… Berjaya dikemaskini!");
                bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
                loadMyTasks(); // Refresh list
            } else {
                alert("Ralat: " + r.message);
                btn.innerHTML="SIMPAN & HANTAR"; btn.disabled=false;
            }
        }

        // --- TASKS LOADER ---
        async function loadMyTasks() {
            const c = document.getElementById('taskContainer');
            c.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';
            const d = await postData('getMyTasks', {name: uProf.name});
            const tasks = d.rows || [];
            
            document.getElementById('badgeTask').innerText = tasks.length;
            document.getElementById('badgeTask').style.display = tasks.length ? 'inline-block' : 'none';

            if(!tasks.length) { c.innerHTML='<div class="col-12 text-center p-5 text-muted">Tiada tugasan.</div>'; return; }
            
            c.innerHTML = "";
            tasks.forEach(t => {
                // Mapping index col is fragile, better use headers if available
                // Assuming standard: 6=Lokasi, 9=Tanaman, 3=Tarikh, 20=Status
                const loc = t.data[6] || t.data[7];
                const crop = t.data[9] || t.data[10];
                const date = t.data[3] || t.data[4];
                const reason = t.data[21] || "Sila semak data"; // Log col 21

                c.innerHTML += `
                <div class="col-md-6 col-xl-4">
                    <div class="verify-card bg-white rounded-3 shadow-sm border mb-3 h-100 border-danger">
                        <div class="p-3 border-bottom bg-danger bg-opacity-10">
                            <div class="fw-bold text-dark">${loc}</div>
                            <small class="text-muted">${crop} | ${date}</small>
                            <span class="badge bg-danger float-end">DITOLAK</span>
                        </div>
                        <div class="p-3">
                            <div class="task-reject-box p-2 mb-3 small"><i class="bi bi-info-circle me-1"></i> ${reason}</div>
                            <button class="btn btn-danger w-100 btn-sm fw-bold" onclick='openTaskEdit(${JSON.stringify(t)})'>KEMASKINI</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        function openTaskEdit(taskObj) {
            renderEditForm(taskObj.row, taskObj.data);
        }

        // [REQ 4] PDF PER ROW
        async function dlRowPDF(idx) {
            const rData = fData[idx];
            if(!rData) return;
            
            const btn = event.target.closest('button');
            const orig = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;

            const m = {
                user: uProf.name,
                negeri: rData.n, 
                dates: rData.t // Single date
            };

            // Hantar array satu item sahaja
            const r = await postData('genPDF', { data: [rData], meta: m });
            
            if (r.success) {
                const a = document.createElement('a');
                a.href = "data:application/pdf;base64," + r.base64;
                a.download = r.filename; 
                a.click();
            } else {
                alert("Gagal: " + r.message);
            }
            btn.innerHTML = orig; btn.disabled = false;
        }

        // --- HELPER LAIN ---
        function updateDistricts(sId, tId) {
            const s = document.getElementById(sId).value;
            const t = document.getElementById(tId);
            t.innerHTML = '<option value="">- Pilih -</option>';
            if(s && districtData[s]) districtData[s].forEach(x=>t.innerHTML+=`<option value="${x}">${x}</option>`);
        }
        function switchTab(t, el) {
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            if(el) el.classList.add('active');
            ['main','tasks','verify','form'].forEach(v => document.getElementById('view-'+v).style.display = (v===t?'block':'none'));
            if(t==='main' && map) setTimeout(()=>map.invalidateSize(),300);
        }
        function doLogout() { location.reload(); }

        // [REQ 1] FORMAT SYOR
        function formatSyorPerenggan(teksInput) {
            if (!teksInput) return "";
            return String(teksInput).split(/[;\n]+/)
                .map(t => t.trim()).filter(t => t.length > 0)
                .map(t => {
                    let s = t.charAt(0).toUpperCase() + t.slice(1);
                    if (!s.endsWith('.')) s += '.';
                    return s;
                }).join(' ');
        }
    </script>
</body>
</html>
